@using System.Reflection
@{
    string classCode = ViewBag.ClassCode != null ? ViewBag.ClassCode.ToString() : "";
    
    // Try to get name from multiple sources
    string studentName = "";
    string studentInitials = "";
    
    // 1. Try ViewBag first (set by controllers)
    if (ViewBag.AdminName != null) studentName = ViewBag.AdminName.ToString();
    if (ViewBag.AdminInitials != null) studentInitials = ViewBag.AdminInitials.ToString();
    
    // 2. Try Model properties
    if (string.IsNullOrWhiteSpace(studentName))
    {
        var modelType = Model?.GetType();
        var nameProp = modelType?.GetProperty("UserName") ?? modelType?.GetProperty("StudentName");
        if (nameProp != null)
        {
            studentName = nameProp.GetValue(Model)?.ToString() ?? "";
        }
    }
    
    if (string.IsNullOrWhiteSpace(studentInitials))
    {
        var modelType = Model?.GetType();
        var avatarProp = modelType?.GetProperty("Avatar") ?? modelType?.GetProperty("StudentInitials");
        if (avatarProp != null)
        {
            studentInitials = avatarProp.GetValue(Model)?.ToString() ?? "";
        }
    }
    
    // 3. Try Session (set during login) - get from Context directly
    if (string.IsNullOrWhiteSpace(studentName) && Context?.Session != null)
    {
        studentName = Context.Session.GetString("UserName") ?? "";
    }
    
    // 4. Build initials from name if not set
    if (string.IsNullOrWhiteSpace(studentInitials) && !string.IsNullOrWhiteSpace(studentName))
    {
        var nameParts = studentName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (nameParts.Length > 0)
        {
            if (nameParts.Length > 1)
            {
                // First letter of first name + first letter of last name
                studentInitials = (nameParts[0][0].ToString() + nameParts[nameParts.Length - 1][0].ToString()).ToUpper();
            }
            else
            {
                // Just first letter of first name
                studentInitials = nameParts[0][0].ToString().ToUpper();
            }
        }
    }
    
    // 5. Fallback defaults
    if (string.IsNullOrWhiteSpace(studentName)) studentName = "Student";
    if (string.IsNullOrWhiteSpace(studentInitials)) studentInitials = "ST";
}

<div class="bottom-bar">
    <div class="user-profile" id="userProfile">
        <div class="user-avatar">@studentInitials</div>
        <div class="user-name">@studentName</div>
        <div class="user-popup" id="userPopup">
            <span id="signOutBtn">Exit â€¢ Sign out</span>
        </div>
    </div>

    <div class="menu-wrap">
        <div class="menu-circle" id="menuCircle" title="Open menu" role="button" tabindex="0">
            <div class="menu-grid"><span></span><span></span><span></span><span></span></div>
        </div>

        <div class="radial-actions" id="radialActions">
            <button class="action home" id="stuHome" data-page="home" data-label="Home"><i class="fa-solid fa-house"></i></button>
            <button class="action subjects locked" id="stuSubjects" data-page="locked" data-label="Locked" aria-label="Locked"><i class="fa-solid fa-lock"></i></button>
            <button class="action todo" id="stuTodo" data-page="todo" data-label="To-Do"><i class="fa-solid fa-pencil"></i></button>
        </div>
    </div>

    <div class="right-space"></div>
    <script>
        window.studentBottomBarData = {
            classCode: '@classCode',
            currentPage: '@ViewBag.CurrentPage'
        };
    </script>
    <script src="~/js/StudentDb/StudentBottomBar.js" asp-append-version="true"></script>
</div>
