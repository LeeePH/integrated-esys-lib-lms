@model ShifterEnrollmentRequest
@{
    ViewData["Title"] = "Shifter Request Details";
    Layout = "~/Areas/Admin/Views/Shared/Admin_Layout.cshtml";

    var currentEnrollment = ViewBag.CurrentEnrollment as EnrollmentRequest;
    var subjectRemarks = ViewBag.SubjectRemarks as List<StudentSubjectRemarks> ?? new List<StudentSubjectRemarks>();
    var currentProgramSubjects = ViewBag.CurrentProgramSubjects as List<SubjectRow> ?? new List<SubjectRow>();
    var targetProgramSubjects = ViewBag.TargetProgramSubjects as List<SubjectRow> ?? new List<SubjectRow>();
    var matchedSubjects = ViewBag.MatchedSubjects as List<ShifterSubjectMatchViewModel> ?? new List<ShifterSubjectMatchViewModel>();

}

<style>
    .info-card {
        border-left: 4px solid #066B99;
        background: #f8f9fa;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .status-badge-large {
        font-size: 1.1rem;
        padding: 0.5rem 1rem;
    }

    .subject-match-table td, .subject-match-table th {
        vertical-align: middle;
    }

    .credited-row {
        background-color: #e8f5e9;
    }

    .not-credited-row {
        background-color: #fff3e0;
    }
</style>

@if (TempData["Error"] is string err)
{
    <div class="alert alert-danger alert-dismissible">
        <i class="fas fa-exclamation-triangle me-2"></i>@err
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Success"] is string ok)
{
    <div class="alert alert-success alert-dismissible">
        <i class="fas fa-check-circle me-2"></i>@ok
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="container-fluid py-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3><i class="fas fa-exchange-alt me-2"></i>Shifter Enrollment Request</h3>
            <p class="text-muted mb-0">
                <strong>Request ID:</strong> @Model.Id<br />
                <strong>Submitted:</strong> @Model.SubmittedDate.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")
            </p>
        </div>
        <div>
            <span class="badge status-badge-large bg-@GetStatusColor(Model.Status)">
                @Model.Status
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Request Information -->
        <div class="col-lg-8">
            <!-- Personal Information -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-user me-2"></i>Personal Information
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Last Name:</strong><br />@Model.LastName
                        </div>
                        <div class="col-md-3">
                            <strong>First Name:</strong><br />@Model.FirstName
                        </div>
                        <div class="col-md-3">
                            <strong>Middle Name:</strong><br />@Model.MiddleName
                        </div>
                        <div class="col-md-3">
                            <strong>Extension:</strong><br />@(Model.Extension ?? "N/A")
                        </div>
                    </div>
                    <hr />
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Sex:</strong> @Model.Sex
                        </div>
                        <div class="col-md-4">
                            <strong>Contact:</strong> @Model.ContactNumber
                        </div>
                        <div class="col-md-4">
                            <strong>Email:</strong> @Model.Email
                        </div>
                    </div>
                </div>
            </div>

            <!-- Academic Information -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-graduation-cap me-2"></i>Academic Information
                </div>
                <div class="card-body">
                    <div class="info-card">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Current Program</h6>
                                <h4>@Model.CourseLastEnrolled</h4>
                                <small class="text-muted">Program last enrolled at QCU</small>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">Shifting To</h6>
                                <h4>@Model.CourseApplyingToShift</h4>
                                <small class="text-muted">Desired program</small>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <strong>Student Username:</strong><br />@Model.StudentUsername
                        </div>
                        <div class="col-md-4">
                            <strong>Units Earned:</strong><br />
                            <span class="badge bg-success">@Model.TotalUnitsEarned units</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Units Failed:</strong><br />
                            <span class="badge bg-danger">@Model.TotalUnitsFailed units</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reason for Shifting -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-comment-alt me-2"></i>Reason for Shifting
                </div>
                <div class="card-body">
                    <p class="mb-0" style="white-space: pre-wrap;">@Model.ReasonForShifting</p>
                </div>
            </div>

            <!-- Subject Comparison Tables -->
            <div class="card mb-3">
                <div class="card-header bg-warning">
                    <i class="fas fa-book me-2"></i>Subject Credit Transfer Analysis
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Credit Transfer:</strong> Subjects that exist in both programs and were passed will be credited (highlighted in green).
                    </div>

                    <h6 class="mb-3">Target Program Subjects (@Model.CourseApplyingToShift - 1st Semester)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered subject-match-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Code</th>
                                    <th>Title</th>
                                    <th>Units</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var subject in matchedSubjects)
                                {
                                    var rowClass = subject.IsCredited ? "credited-row" : (subject.IsMatched ? "not-credited-row" : "");
                                    <tr class="@rowClass">
                                        <td><strong>@subject.SubjectCode</strong></td>
                                        <td>@subject.SubjectTitle</td>
                                        <td>@subject.Units</td>
                                        <td>
                                            @if (subject.IsCredited)
                                            {
                                                <span class="badge bg-success"><i class="fas fa-check me-1"></i>Credited</span>
                                            }
                                            else if (subject.IsMatched && subject.IsPassed)
                                            {
                                                <span class="badge bg-primary">Passed (Different Program)</span>
                                            }
                                            else if (subject.IsMatched)
                                            {
                                                <span class="badge bg-danger">@subject.Remark</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">New Subject</span>
                                            }
                                        </td>
                                        <td>
                                            @if (subject.IsCredited)
                                            {
                                                <small class="text-success"><i class="fas fa-check-circle me-1"></i>Skip (Credited)</small>
                                            }
                                            else
                                            {
                                                <small class="text-warning"><i class="fas fa-redo me-1"></i>Must Enroll</small>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <span class="badge bg-success me-2">@matchedSubjects.Count(s => s.IsCredited) subjects credited</span>
                        <span class="badge bg-warning">@matchedSubjects.Count(s => !s.IsCredited) subjects to enroll</span>
                    </div>
                </div>
            </div>

            <!-- Subject History -->
            @if (subjectRemarks.Any())
            {
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-history me-2"></i>Student's Subject History
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Title</th>
                                        <th>Units</th>
                                        <th>Semester</th>
                                        <th>Program</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var remark in subjectRemarks.OrderBy(r => r.SemesterTaken))
                                    {
                                        var badgeClass = remark.Remark.Equals("Pass", StringComparison.OrdinalIgnoreCase) ? "bg-success" :
                                        remark.Remark.Equals("Fail", StringComparison.OrdinalIgnoreCase) ? "bg-danger" : "bg-warning";
                                        <tr>
                                            <td><strong>@remark.SubjectCode</strong></td>
                                            <td>@remark.SubjectTitle</td>
                                            <td>@remark.Units</td>
                                            <td>@remark.SemesterTaken</td>
                                            <td>@remark.Program</td>
                                            <td><span class="badge @badgeClass">@remark.Remark</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Right Column: Documents & Actions -->
        <div class="col-lg-4">
            <!-- Status & Timeline -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fas fa-clock me-2"></i>Timeline
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-paper-plane text-primary me-2"></i>
                            <strong>Submitted:</strong><br />
                            <small>@Model.SubmittedDate.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")</small>
                        </li>
                        @if (Model.ReviewedDate.HasValue)
                        {
                            <li class="mb-2">
                                <i class="fas fa-eye text-info me-2"></i>
                                <strong>Reviewed:</strong><br />
                                <small>@Model.ReviewedDate.Value.ToLocalTime().ToString("MMM dd, yyyy hh:mm tt")</small>
                            </li>
                        }
                        <li class="mb-2">
                            <i class="fas fa-calendar text-secondary me-2"></i>
                            <strong>Semester:</strong> @Model.CurrentSemester
                        </li>
                        <li>
                            <i class="fas fa-graduation-cap text-secondary me-2"></i>
                            <strong>Academic Year:</strong> @Model.CurrentAcademicYear
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Submitted Documents -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fas fa-file-alt me-2"></i>Submitted Documents
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <strong>Endorsement Letter:</strong><br />
                        @if (!string.IsNullOrWhiteSpace(Model.EndorsementLetterPath))
                        {
                            <a href="@Model.EndorsementLetterPath" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file-pdf me-1"></i>View Document
                            </a>
                        }
                        else
                        {
                            <span class="badge bg-warning">Not Submitted</span>
                        }
                    </div>
                    <div>
                        <strong>Library Clearance:</strong><br />
                        @if (!string.IsNullOrWhiteSpace(Model.LibraryClearancePath))
                        {
                            <a href="@Model.LibraryClearancePath" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-file-pdf me-1"></i>View Document
                            </a>
                        }
                        else
                        {
                            <span class="badge bg-warning">Not Submitted</span>
                        }
                    </div>
                </div>
            </div>

            <!-- Admin Notes -->
            @if (!string.IsNullOrWhiteSpace(Model.AdminNotes))
            {
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-sticky-note me-2"></i>Admin Notes
                    </div>
                    <div class="card-body">
                        <p class="mb-0" style="white-space: pre-wrap;">@Model.AdminNotes</p>
                    </div>
                </div>
            }

            <!-- Actions -->
            @if (Model.Status == "Pending")
            {
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-tasks me-2"></i>Actions
                    </div>
                    <div class="card-body">
                        <form asp-action="AcceptShifterRequest" method="post" class="mb-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-success w-100 mb-2" onclick="return confirm('Accept this shifter request? The student will be shifted to @Model.CourseApplyingToShift.');">
                                <i class="fas fa-check me-2"></i>Accept Request
                            </button>
                        </form>

                        <button type="button" class="btn btn-warning w-100 mb-2" data-bs-toggle="modal" data-bs-target="#holdModal">
                            <i class="fas fa-pause me-2"></i>Put On Hold
                        </button>

                        <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#rejectModal">
                            <i class="fas fa-times me-2"></i>Reject Request
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This request has been <strong>@Model.Status</strong> and cannot be modified.
                </div>
            }
        </div>
    </div>
</div>

<!-- Hold Modal -->
<div class="modal fade" id="holdModal" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="HoldShifterRequest" method="post">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-pause me-2"></i>Put Request On Hold</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="mb-3">
                        <label class="form-label">Reason for holding:</label>
                        <textarea name="reason" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Put On Hold</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="RejectShifterRequest" method="post">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-times me-2"></i>Reject Shifter Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="mb-3">
                        <label class="form-label">Reason for rejection: <span class="text-danger">*</span></label>
                        <textarea name="reason" class="form-control" rows="3" required
                                  placeholder="Provide a clear reason for rejection..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Notes (Optional):</label>
                        <textarea name="notes" class="form-control" rows="2"
                                  placeholder="Any additional information..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject Request</button>
                </div>
            </div>
        </form>
    </div>
</div>

@functions {
    string GetStatusColor(string status)
    {
        return status switch
        {
            "Pending" => "warning",
            "Accepted" => "success",
            "Rejected" => "danger",
            "On-Hold" => "secondary",
            _ => "info"
        };
    }
}