@model E_SysV0._01.Models.AdminRegistrationSlipViewModel

<div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="true" data-no-redirect="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registrationModalLabel">Student Registration Form</h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-primary btn-sm" onclick="openRegistrationSlipPdf('@Model.RequestId')">
                        <i class="bi bi-save"></i> Save
                    </button>

                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <style>
                    .btn-outline-secondary.btn-sm:hover {
                        background-color: #066B99;
                        color: white !important;
                        border-color: #066B99;
                        transition: all 0.3s ease;
                    }
                </style>
            </div>
            <div class="modal-body" id="registrationPrintArea">
                <style>
                    /* Screen styling (modal) */
                    #registrationPrintArea { color:#111827; font-size:12px; line-height:1.25; }
                    .reg-header { text-align:center; margin-bottom:.6rem; }
                    .reg-header h3 { font-size:1.1rem; margin:0; }
                    .reg-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:.35rem .5rem; margin-bottom:.6rem; }
                    .reg-label { color:#6b7280; }
                    .reg-value { font-weight:600; }
                    .reg-table table { width:100%; border-collapse:collapse; font-size:11px; margin:0; }
                    .reg-table th,.reg-table td { border:1px solid #d1d5db; padding:.3rem .4rem; }
                    .reg-table th { background:#f3f4f6; text-transform:uppercase; font-size:.7rem; letter-spacing:.04em; }
                    .sig-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:.8rem; }
                    .sig-block { text-align:center; }
                    .sig-line { margin-top:1rem; border-top:1px solid #111827; padding-top:.2rem; font-weight:600; }
                    .sig-hint { font-size:.8rem; color:#6b7280; }
                    @@media (max-width:992px){ .reg-grid{ grid-template-columns:repeat(2,1fr);} }
                    @@media (max-width:576px){ .reg-grid{ grid-template-columns:1fr;} }
                </style>

                <div class="reg-header">
                    <h3>Registration Form</h3>
                    <div class="text-muted">Academic: @Model.YearLevel • @Model.Semester</div>
                </div>

                <div class="reg-grid">
                    <div><span class="reg-label">Course/Program</span><div class="reg-value">@Model.Program</div></div>
                    <div><span class="reg-label">Year Level</span><div class="reg-value">@Model.YearLevel</div></div>
                    <div><span class="reg-label">Section</span><div class="reg-value">@Model.SectionName</div></div>
                    <div><span class="reg-label">Regularity</span><div class="reg-value">@Model.Regularity</div></div>

                    <div><span class="reg-label">Graduating</span><div class="reg-value">@Model.GraduatingStatus</div></div>
                    <div><span class="reg-label">Date Enrolled</span><div class="reg-value">@Model.DateEnrolledLocal.ToString("MMM dd, yyyy")</div></div>
                    <div><span class="reg-label">Date of Registration</span><div class="reg-value">@Model.RegistrationDateLocal.ToString("MMM dd, yyyy")</div></div>
                </div>

                <div class="reg-grid" style="grid-template-columns: repeat(3,1fr);">
                    <div><span class="reg-label">Student Number</span><div class="reg-value">@Model.StudentNumber</div></div>
                    <div><span class="reg-label">Last Name</span><div class="reg-value">@Model.LastName</div></div>
                    <div><span class="reg-label">First Name</span><div class="reg-value">@Model.FirstName</div></div>
                    <div><span class="reg-label">Middle Name</span><div class="reg-value">@Model.MiddleName</div></div>
                </div>

                <div class="reg-table mt-2">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 12%;">Subject Code</th>
                                <th>Subject Name</th>
                                <th style="width: 8%;">Units</th>
                                <th style="width: 16%;">Room</th>
                                <th style="width: 20%;">Time/Schedule</th>
                                <th style="width: 24%;">Professor Signature</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Subjects.Count == 0)
                            {
                                <tr><td colspan="6" class="text-center text-muted">No classes scheduled.</td></tr>
                            }
                            else
                            {
                                @foreach (var s in Model.Subjects)
                                {
                                    <tr>
                                        <td>
                                            @s.Code
                                            @if (s.IsRetake)
                                            {
                                                <span class="badge bg-warning text-dark ms-1">RETAKE</span>
                                            }
                                        </td>
                                        <td>@s.Title</td>
                                        <td class="text-center">@s.Units</td>
                                        <td>@s.Room</td>
                                        <td>@s.Schedule</td>
                                        <td></td> @* Professor Signature column *@
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="sig-row">
                    <div class="sig-block">
                        <div class="sig-line">Student Signature</div>
                        <div class="sig-hint">Sign over printed name</div>
                    </div>
                    <div class="sig-block">
                        <div class="sig-line">@Model.DeanName</div>
                        <div class="sig-hint">Dean</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Print the slip content without opening a new tab (hidden iframe) and force single page
    function printRegistrationSlip() {
        const area = document.getElementById('registrationPrintArea');
        if (!area) { window.print(); return; }

        const html = `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Registration Form</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<style>
  @@page { size: A4 landscape; margin: 8mm; } /* a bit smaller margin to gain height */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { margin:0; padding:0; }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    font-size: 12px; color:#111827; line-height:1.2; overflow:hidden; /* clip any tiny overflow to avoid page 2 */
  }
  .print-container {
    width: 281mm; /* 297 - (8*2) */
    margin: 0 auto;
    transform: scale(0.98);              /* slight shrink to keep within one page */
    transform-origin: top left;
  }
  h1,h2,h3,h4,h5,h6,p { margin:0; }
  .reg-header { text-align:center; margin-bottom:.5rem; }
  .reg-header h3 { font-size:1.05rem; margin:0; }
  .reg-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:.3rem .5rem; margin-bottom:.5rem; }
  .reg-label { color:#6b7280; }
  .reg-value { font-weight:600; }
  .reg-table table { width:100%; border-collapse:collapse; font-size:10.5px; margin:0; }
  .reg-table th, .reg-table td { border:1px solid #d1d5db; padding:.28rem .38rem; }
  .reg-table th { background:#f3f4f6; text-transform:uppercase; font-size:.68rem; letter-spacing:.04em; }
  .sig-row { display:grid; grid-template-columns:1fr 1fr; gap:.9rem; margin-top:.7rem; }
  .sig-block { text-align:center; }
  .sig-line { margin-top:.9rem; border-top:1px solid #111827; padding-top:.18rem; font-weight:600; }
  .sig-hint { font-size:.78rem; color:#6b7280; }

  /* Prevent breaks within key areas */
  .reg-grid, .reg-table, .sig-row, table, thead, tbody, tr, td, th {
      break-inside: avoid; page-break-inside: avoid;
  }
</style>
</head>
<body>
  <div class="print-container">
    ${area.innerHTML}
  </div>
  <script>
    window.onload = function() {
      window.focus();
      window.print();
      setTimeout(function(){ window.close(); }, 50);
    };
  <\/script>
</body>
</html>`;

        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);

        const w = iframe.contentWindow || iframe.contentDocument;
        const d = w.document || w;
        d.open(); d.write(html); d.close();

        const cleanup = () => setTimeout(() => iframe.remove(), 100);
        try { w.onafterprint = cleanup; } catch { cleanup(); }
    }

        function openRegistrationSlipPdf(requestId) {
            if (!requestId) {
                // fallback to current behavior
                printRegistrationSlip();
                return;
            }
            const url = '/Admin/RegistrationSlip/Print?requestId=' + encodeURIComponent(requestId);
            window.open(url, '_blank');
        }
</script>