(function () {
    const RESET_MODAL_ID = 'ResetPasswordModal';
    const RESET_CONFIG_ID = 'resetModalConfig';
    const FORGOT_FORM_SELECTOR = 'form[action*="ForgotPassword"]';

    function policyChecks(pwd) {
        return {
            len: pwd.length >= 8 && pwd.length <= 64,
            upper: /[A-Z]/.test(pwd),
            lower: /[a-z]/.test(pwd),
            digit: /\d/.test(pwd),
            symbol: /[^A-Za-z0-9]/.test(pwd),
            space: !/\s/.test(pwd)
        };
    }

    function updatePolicyUI(pwd) {
        const checks = policyChecks(pwd);
        const list = document.getElementById('rpPolicyList');
        if (list) {
            list.querySelectorAll('li[data-rule]').forEach(li => {
                const key = li.getAttribute('data-rule');
                const ok = !!checks[key];
                li.classList.toggle('text-success', ok);
                li.classList.toggle('text-danger', !ok);
            });
        }
        const bar = document.getElementById('rpStrengthBar');
        if (bar) {
            const total = 6;
            const passed = Object.values(checks).filter(Boolean).length;
            const pct = Math.round((passed / total) * 100);
            bar.style.width = pct + '%';
            bar.classList.remove('bg-danger', 'bg-warning', 'bg-success');
            if (pct < 50) bar.classList.add('bg-danger');
            else if (pct < 84) bar.classList.add('bg-warning');
            else bar.classList.add('bg-success');
        }
    }

    function updateMatchUI() {
        const a = document.getElementById('rpNewPassword');
        const b = document.getElementById('rpConfirmPassword');
        const hint = document.getElementById('rpMatchHint');
        if (!a || !b || !hint) return;
        const mismatch = a.value.length > 0 && b.value.length > 0 && a.value !== b.value;
        hint.classList.toggle('d-none', !mismatch);
    }

    function resetSubmitStateForModal(modalId) {
        const m = document.getElementById(modalId);
        if (!m) return;
        const btn = m.querySelector('form button[type="submit"]');
        if (btn) {
            btn.disabled = false;
            if (btn.dataset.originalText) {
                btn.textContent = btn.dataset.originalText;
            }
        }
    }

    function showAlertInModal(modalEl, html, variant = 'success') {
        if (!modalEl) return;
        const body = modalEl.querySelector('.modal-body');
        if (!body) return;
        const prev = body.querySelector('.js-forgot-alert');
        if (prev) prev.remove();
        const container = document.createElement('div');
        container.className = `js-forgot-alert alert alert-${variant} mb-3`;
        container.innerHTML = html;
        body.prepend(container);
    }

    // Submit ForgotPassword via AJAX to stay on modal
    async function wireForgotFormAjax() {
        const form = document.querySelector(FORGOT_FORM_SELECTOR);
        if (!form) return;

        form.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            ev.stopPropagation();

            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
                btn.dataset.originalText = btn.textContent || '';
                btn.disabled = true;
                btn.textContent = 'Sending...';
            }

            const fd = new FormData(form);

            try {
                // pick antiforgery token from the form (hidden input generated by @Html.AntiForgeryToken())
                const afInput = form.querySelector('input[name="__RequestVerificationToken"]');
                const afToken = afInput ? (afInput.value || '') : '';

                const headers = {
                    'X-Requested-With': 'XMLHttpRequest'
                };
                if (afToken) headers['RequestVerificationToken'] = afToken;

                const resp = await fetch(form.action, {
                    method: 'POST',
                    body: fd,
                    headers,
                    credentials: 'same-origin',
                    redirect: 'follow'
                });

                // Try to parse JSON if possible
                const ct = resp.headers.get('Content-Type') || '';
                if (resp.ok && ct.includes('application/json')) {
                    const data = await resp.json();
                    if (data && data.success) {
                        const modalEl = form.closest('.modal');
                        showAlertInModal(modalEl, data.message || 'If an account exists, an email was sent.');
                        // disable input fields to indicate completed request
                        form.querySelectorAll('input').forEach(i => i.disabled = true);

                        // show transient button state "Sent" and re-enable after 4s
                        if (btn) {
                            btn.textContent = 'Sent';
                            setTimeout(() => {
                                btn.disabled = false;
                                if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
                            }, 4000);
                        }
                        return;
                    }

                    // JSON but failure
                    const modalEl = form.closest('.modal');
                    showAlertInModal(modalEl, (data && data.message) ? data.message : 'Failed to send reset link.', 'danger');
                    if (btn) {
                        btn.disabled = false;
                        if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
                    }
                    return;
                }

                // Non-JSON or fallback
                const text = await resp.text();
                const modalEl = form.closest('.modal');

                // best-effort detection
                if (resp.ok || /If an account exists for that email/i.test(text)) {
                    showAlertInModal(modalEl, 'If an account exists for that email, a reset link has been sent.');
                    form.querySelectorAll('input').forEach(i => i.disabled = true);
                    if (btn) {
                        btn.textContent = 'Sent';
                        setTimeout(() => {
                            btn.disabled = false;
                            if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
                        }, 4000);
                    }
                } else {
                    showAlertInModal(modalEl, 'Failed to send reset link. Please try again.', 'danger');
                    if (btn) {
                        btn.disabled = false;
                        if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
                    }
                }
            } catch (err) {
                const modalEl = form.closest('.modal');
                showAlertInModal(modalEl, 'Network error while sending reset link. Please try again.', 'danger');
                if (btn) {
                    btn.disabled = false;
                    if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
                }
            }
        });
    }

    // Auto-open reset modal when controller flagged it; populate hidden fields
    function maybeOpenResetModalFromConfig() {
        const cfg = document.getElementById(RESET_CONFIG_ID);
        if (!cfg || cfg.dataset.open !== 'true') return;

        const el = document.getElementById(RESET_MODAL_ID);
        if (!el) return;

        const email = cfg.dataset.email || '';
        const token = cfg.dataset.token || '';

        const hEmail = document.getElementById('resetEmail');
        const hToken = document.getElementById('resetToken');
        if (hEmail) hEmail.value = email;
        if (hToken) hToken.value = token;

        if (typeof bootstrap !== 'undefined') {
            const modal = new bootstrap.Modal(el, { backdrop: 'static', keyboard: false });
            modal.show();
        }
    }

    // Wire up live UI updates
    function wireInputs() {
        const np = document.getElementById('rpNewPassword');
        const cp = document.getElementById('rpConfirmPassword');

        np?.addEventListener('input', () => { updatePolicyUI(np.value); updateMatchUI(); });
        cp?.addEventListener('input', updateMatchUI);
    }

    // Submit handling: client validation + submit guard for reset form
    function wireSubmitGuard() {
        document.addEventListener('submit', (e) => {
            const form = e.target;
            if (!(form instanceof HTMLFormElement)) return;

            const action = (form.getAttribute('action') || '').toLowerCase();

            if (action.includes('resetpassword')) {
                const np = form.querySelector('#rpNewPassword');
                const cp = form.querySelector('#rpConfirmPassword');
                const btn = form.querySelector('button[type="submit"]');

                const newPwd = np ? (np.value || '') : '';
                const conf = cp ? (cp.value || '') : '';

                const checks = policyChecks(newPwd);
                const allOk = Object.values(checks).every(Boolean);
                const match = newPwd === conf;

                if (!allOk || !match) {
                    e.preventDefault();
                    e.stopPropagation();
                    updatePolicyUI(newPwd);
                    updateMatchUI();
                    if (btn) {
                        btn.disabled = false;
                        if (btn.dataset.originalText) btn.textContent = btn.dataset.originalText;
                    }
                    return;
                }

                if (btn) {
                    btn.dataset.originalText = btn.textContent || '';
                    btn.disabled = true;
                    btn.textContent = 'Resetting...';
                }
            }
        }, { passive: false });
    }

    // Re-enable submit on modal show/hidden and on page show (bfcache)
    function wireModalLifecycle() {
        document.addEventListener('shown.bs.modal', (e) => {
            if (!e.target) return;
            if (e.target.id === RESET_MODAL_ID) {
                resetSubmitStateForModal(RESET_MODAL_ID);
                updatePolicyUI(document.getElementById('rpNewPassword')?.value || '');
                updateMatchUI();
            }
        });
        document.addEventListener('hidden.bs.modal', (e) => {
            if (!e.target) return;
            if (e.target.id === RESET_MODAL_ID) {
                resetSubmitStateForModal(RESET_MODAL_ID);
            }
        });
        window.addEventListener('pageshow', () => resetSubmitStateForModal(RESET_MODAL_ID));
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        maybeOpenResetModalFromConfig();
        wireInputs();
        wireSubmitGuard();
        wireModalLifecycle();
        wireForgotFormAjax();
    });
})();