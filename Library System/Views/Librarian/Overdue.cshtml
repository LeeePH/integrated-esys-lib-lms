@model SystemLibrary.ViewModels.OverdueReportViewModel
@{
    ViewBag.Title = "Reports and Analytics - Overdue Accounts";
    ViewBag.ActiveTab = "overdue";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/overdue.css" />

<style>
    .export-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .export-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.3s ease;
    }

    .export-btn:hover {
        background-color: #3367d6;
    }

    .export-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .export-btn svg {
        width: 16px;
        height: 16px;
    }

    .modal-export-btn {
        background-color: #22b573;
        margin-right: 10px;
    }

    .modal-export-btn:hover {
        background-color: #1a8a5a;
    }

    .popup-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }

    /* Clickable stats styling */
    .clickable-stat {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .clickable-stat:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Detailed Data Section */
    .detailed-data-section {
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .detailed-data-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #333;
    }

    .detailed-data-content {
        overflow-x: auto;
    }

    .table-responsive {
        width: 100%;
        overflow-x: auto;
    }

    .table-responsive table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .table-responsive th,
    .table-responsive td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .table-responsive th {
        background-color: #f5f5f5;
        font-weight: 600;
        color: #333;
    }

    .table-responsive tbody tr:hover {
        background-color: #f9f9f9;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-danger {
        background-color: #fee;
        color: #c00;
    }

    .badge-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-success {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }
</style>

<main class="content">
    <!-- Header -->
    <header>
        <h1>Reports and Analytics</h1>
        <div class="filter">
            <select id="overdueFilter" onchange="filterByDateRange(this.value)">
                <option value="30" selected="@(Model.DaysRange == 30)">Last 30 Days</option>
                <option value="60" selected="@(Model.DaysRange == 60)">Last 60 Days</option>
                <option value="90" selected="@(Model.DaysRange == 90)">Last 90 Days</option>
            </select>
        </div>
    </header>

    <!-- Tabs -->
    <section class="tabs">
        @await Html.PartialAsync("_ReportTabs")
    </section>

    <!-- Overdue Accounts Report -->
    <section class="report-card">
        <div class="report-header">
            <h2>Overdue Accounts</h2>
            <div class="header-controls">
                <div class="search-box">
                    <input type="text" placeholder="Search overdue accounts..." id="searchOverdue" onkeyup="searchOverdueAccounts()" />
                    <img src="~/images/searchicon.png" alt="Search" class="search-icon" />
                </div>
                <div class="filter-controls">
                    <select id="statusFilter" onchange="filterByStatus()">
                        <option value="all">All Accounts</option>
                        <option value="restricted">Restricted Only</option>
                        <option value="active">Active Only</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat red clickable-stat" data-type="overdueaccounts">
                <h3>@Model.TotalOverdueAccounts</h3>
                <p>Overdue Accounts</p>
            </div>
            <div class="stat orange clickable-stat" data-type="overduebooks">
                <h3>@Model.TotalOverdueBooks</h3>
                <p>Overdue Books</p>
            </div>
            <div class="stat green clickable-stat" data-type="totalfees">
                <h3>₱@Model.TotalFees.ToString("N2")</h3>
                <p>Total Fees</p>
            </div>
        </div>

        <!-- Table -->
        <div class="table-wrapper" id="overdueAccountsSection" style="display:none;">
            <div class="filter-row" style="margin-bottom: 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <strong>Filter by Due Date (month):</strong>
                <input type="month" id="overdueTableFrom" class="form-control" style="width:auto; padding:6px 8px; height:auto;">
                <input type="month" id="overdueTableTo" class="form-control" style="width:auto; padding:6px 8px; height:auto;">
                <button id="btnFilterOverdueAccounts" class="btn btn-outline-primary btn-sm" onclick="filterOverdueAccountsTable()">Filter</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetOverdueAccountsTable()">Reset</button>
            </div>
            @if (Model.OverdueAccounts.Any())
            {
                <table id="overdueBooksTable">
                    <thead>
                        <tr>
                            <th style="cursor:pointer" data-col="0" data-type="string">Student <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="1" data-type="number">Overdue Books <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="2" data-type="date">Earliest Due Date <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="3" data-type="number">Days Overdue <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="4" data-type="string">Status <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="overdueTable">
                        @foreach (var account in Model.OverdueAccounts.OrderByDescending(a => a.OverdueBooks?.OrderBy(b => b.DueDate).FirstOrDefault()?.DueDate ?? DateTime.MinValue))
                        {
                            <tr class="overdue-row" 
                                data-student="@account.StudentName.ToLower()" 
                                data-number="@account.StudentNumber.ToLower()"
                                data-student-name="@account.StudentName"
                                data-overdue-count="@account.OverdueBookCount"
                                data-days-overdue="@account.MaxDaysOverdue"
                                data-status="@(account.IsRestricted ? "Restricted" : "Active")"
                                data-overdue-books='@Html.Raw(Json.Serialize(account.OverdueBooks))'>
                                <td>@account.StudentName</td>
                                <td>@account.OverdueBookCount</td>
                                @{
                                    var earliestDue = account.OverdueBooks?.OrderBy(b => b.DueDate).FirstOrDefault()?.DueDate;
                                }
                                <td data-due="@earliestDue?.ToString("yyyy-MM-dd")">@earliestDue?.ToString("MMM dd, yyyy")</td>
                                <td>@account.MaxDaysOverdue</td>
                                <td>
                                    @if (account.IsRestricted)
                                    {
                                        <span class="restricted">Restricted</span>
                                    }
                                    else
                                    {
                                        <span class="active">Active</span>
                                    }
                                </td>
                                <td>
                                    @if (account.IsRestricted)
                                    {
                                        <button class="request-btn @(account.HasPendingRequest ? "disabled" : "active")" 
                                                id="unrestrictBtn_@account.UserId"
                                                data-user-id="@account.UserId"
                                                data-student-name="@account.StudentName"
                                                onclick="showUnrestrictPopup(@Html.Raw(Json.Serialize(account.UserId)), @Html.Raw(Json.Serialize(account.StudentName)), this)"
                                                @(account.HasPendingRequest ? "disabled" : "")>
                                            @(account.HasPendingRequest ? "Requested ✓" : "Request Unrestrict User")
                                        </button>
                                    }
                                    else
                                    {
                                        @* <button class="view-btn"  *@
                                        @*         onclick="showOverdueBooks(@Html.Raw(Json.Serialize(account.StudentName)), @Html.Raw(Json.Serialize(account.OverdueBooks)))"> *@
                                        @*     View Details *@
                                        @* </button> *@
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="empty-state">
                    <p>No overdue accounts found</p>
                </div>
            }
        </div>

        <!-- Detailed Data Section -->
        <div id="detailedDataSection" class="detailed-data-section" style="display: none;">
            <div class="detailed-data-header">
                <h3 id="detailedDataTitle">Detailed Data</h3>
                <div class="header-actions">
                    <button id="exportDetailedDataBtn" class="export-btn" onclick="exportDetailedDataToPDF()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export as PDF
                    </button>
                    <button id="closeDetailedData" class="close-btn">&times;</button>
                </div>
            </div>
            <div class="detailed-data-content">
                <div id="detailedDataTable" class="table-responsive">
                    <!-- Data will be populated here -->
                </div>
            </div>
        </div>
    </section>

    <!-- Overdue Books Report -->
    <section class="report-card" id="overdueBooksSection" style="display:none;">
        <div class="report-header">
            <h2>Overdue Books</h2>
        </div>

        <div class="table-wrapper">
            @{
                var overdueBooks = Model.OverdueAccounts
                    .SelectMany(a => a.OverdueBooks.Select(b => new {
                        StudentName = a.StudentName,
                        StudentNumber = a.StudentNumber,
                        BookTitle = b.BookTitle,
                        DueDate = b.DueDate,
                        DaysOverdue = b.DaysOverdue,
                        LateFee = b.LateFee
                    }))
                    .OrderByDescending(b => b.DueDate)
                    .ThenByDescending(b => b.DaysOverdue)
                    .ThenBy(b => b.StudentName)
                    .ToList();
            }

            @if (overdueBooks.Any())
            {
                <div class="filter-row" style="margin-bottom: 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <strong>Filter Overdue Books by Due Date (month):</strong>
                    <input type="month" id="overdueBooksFrom" class="form-control" style="width:auto; padding:6px 8px; height:auto;">
                    <input type="month" id="overdueBooksTo" class="form-control" style="width:auto; padding:6px 8px; height:auto;">
                    <button id="btnFilterOverdueBooks" class="btn btn-outline-primary btn-sm">Filter</button>
                    <button id="btnResetOverdueBooks" class="btn btn-outline-secondary btn-sm">Reset</button>
                </div>
                <table id="overdueBooksListTable" class="sortable-table">
                    <thead>
                        <tr>
                            <th style="cursor:pointer" data-col="0" data-type="string">Student <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="1" data-type="string">Book Title <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="2" data-type="date">Due Date <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="3" data-type="number">Days Overdue <span class="sort-indicator"></span></th>
                            <th style="cursor:pointer" data-col="4" data-type="currency">Late Fee <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var book in overdueBooks)
                        {
                            <tr>
                                <td>
                                    <div style="display:flex; flex-direction:column; gap:2px;">
                                        <span>@book.StudentName</span>
                                        <small style="color:#64748b;">@book.StudentNumber</small>
                                    </div>
                                </td>
                                <td>@book.BookTitle</td>
                                <td>@book.DueDate.ToString("MMM dd, yyyy")</td>
                                <td>@book.DaysOverdue day(s)</td>
                                <td>₱@book.LateFee.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="empty-state">
                    <img src="~/images/empty.png" alt="Empty" />
                    <p>No overdue books found for the selected period.</p>
                </div>
            }
        </div>
    </section>
</main>

<!-- Overdue Books Details Modal -->
<div class="action-popup" id="overdueDetailsModal" style="display: none;">
    <div class="popup-content large">
        <span class="close" onclick="closeOverdueDetails()">&times;</span>
        <h2 id="detailsStudentName"></h2>
        <div id="overdueBooksList"></div>
        <div class="popup-buttons">
            <button class="export-btn modal-export-btn" id="exportDetailsBtn" onclick="exportDetailsToPDF()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export as PDF
            </button>
            <button class="popup-done" onclick="closeOverdueDetails()">Close</button>
        </div>
    </div>
</div>

<!-- Confirm Unrestrict Popup -->
<div class="action-popup" id="confirmUnrestrictPopup">
    <div class="popup-content">
        <div class="popup-icon">
            <img src="/images/bluecheck.png" alt="Confirm Icon" />
        </div>
        <h2>Request Unrestriction?</h2>
        <p>Are you sure you want to request to unrestrict <strong id="unrestrictStudentName"></strong>?</p>
        <div class="popup-buttons">
            <button class="popup-no" onclick="closeUnrestrictPopup()">No</button>
            <button class="popup-yes" onclick="confirmUnrestrict()">Yes</button>
        </div>
    </div>
</div>

<!-- Success Popup -->
<div class="action-popup" id="successUnrestrictPopup">
    <div class="popup-content">
        <div class="popup-icon">
            <img src="/images/bluecheck.png" alt="Success Icon" />
        </div>
        <h2>Request sent to Admin</h2>
        <p>Please wait for admin to unrestrict the user.</p>
        <div class="popup-buttons">
            <button class="popup-done" onclick="closeSuccessPopup()">Done</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        let selectedUserId = null;
        let clickedButton = null;
        let currentStudentName = '';
        let currentOverdueBooks = [];
        let currentDetailedType = '';
        let currentDetailedItems = [];
        let currentDetailedTitle = '';

        // Check and style disabled buttons on page load
        document.addEventListener('DOMContentLoaded', function() {
            const requestButtons = document.querySelectorAll('.request-btn.disabled[data-user-id]');
            requestButtons.forEach(button => {
                button.style.opacity = '0.6';
                button.style.cursor = 'not-allowed';
            });

            // Handle stat card clicks for detailed data
            const statCards = document.querySelectorAll('.clickable-stat');
            const detailedDataSection = document.getElementById('detailedDataSection');
            const detailedDataTitle = document.getElementById('detailedDataTitle');
            const detailedDataTable = document.getElementById('detailedDataTable');
            const closeDetailedData = document.getElementById('closeDetailedData');

            statCards.forEach(card => {
                card.addEventListener('click', function() {
                    const dataType = this.getAttribute('data-type');
                    loadDetailedData(dataType);
                });
            });

            closeDetailedData.addEventListener('click', function() {
                detailedDataSection.style.display = 'none';
            });

            // Ensure filter button is wired safely and expose function on window
            try {
                const btn = document.getElementById('btnFilterOverdueAccounts');
                if (btn) {
                    // Wrap with safe handler to catch errors so page JS doesn't halt
                    btn.addEventListener('click', function (e) {
                        try {
                            if (typeof filterOverdueAccountsTable === 'function') {
                                filterOverdueAccountsTable();
                            } else if (window.filterOverdueAccountsTable) {
                                window.filterOverdueAccountsTable();
                            } else {
                                console.warn('filterOverdueAccountsTable not found');
                            }
                        } catch (err) {
                            console.error('Error running filterOverdueAccountsTable:', err);
                            alert('An error occurred while applying filter. Check browser console for details.');
                        }
                    });
                }

                // Expose function to global in case inline onclick is executed before script loads
                if (typeof filterOverdueAccountsTable === 'function') window.filterOverdueAccountsTable = filterOverdueAccountsTable;
            } catch (ex) {
                console.log('Error attaching filter button handler:', ex);
            }

            // Initialize sortable tables for accounts and books
            try {
                if (typeof initSortableTable === 'function') {
                    initSortableTable('overdueBooksTable');
                    initSortableTable('overdueBooksListTable');
                }
            } catch (e) {
                console.error('Error initializing sortable tables', e);
            }

                // Helper: parse cell value according to type
                function parseCellValue(text, type) {
                    if (type === 'number') {
                        const n = parseFloat(text.toString().replace(/[^0-9.-]/g, ''));
                        return isNaN(n) ? 0 : n;
                    }
                    if (type === 'currency') {
                        const n = parseFloat(text.toString().replace(/[^0-9.-]/g, ''));
                        return isNaN(n) ? 0 : n;
                    }
                    if (type === 'date') {
                        // try Date.parse on common formats
                        const d = Date.parse(text);
                        if (!isNaN(d)) return d;
                        // fallback: try ISO chunk
                        try {
                            const parts = text.split(/[\-\/ ,]+/).filter(Boolean);
                            if (parts.length >= 3) {
                                const maybe = new Date(text);
                                if (!isNaN(maybe)) return maybe.getTime();
                            }
                        } catch (ex) {}
                        return 0;
                    }
                    return text.toString().trim().toLowerCase();
                }

                // Attach sortable behavior to a table by id
                function initSortableTable(tableId) {
                    const table = document.getElementById(tableId);
                    if (!table) return;
                    const thead = table.tHead || table.querySelector('thead');
                    if (!thead) return;
                    const headers = thead.querySelectorAll('th[style*="cursor:pointer"], th[data-col]');
                    headers.forEach(th => {
                        th.style.userSelect = 'none';
                        th.addEventListener('click', function () {
                            const type = th.getAttribute('data-type') || 'string';
                            const colIndex = parseInt(th.getAttribute('data-col')) || Array.from(th.parentElement.children).indexOf(th);
                            const tbody = table.tBodies[0];
                            if (!tbody) return;
                            const rows = Array.from(tbody.querySelectorAll('tr'));
                            const currentOrder = th.getAttribute('data-sort') || 'none';
                            const asc = currentOrder !== 'asc';
                            // clear indicators
                            headers.forEach(h => { h.setAttribute('data-sort', 'none'); const ind = h.querySelector('.sort-indicator'); if (ind) ind.textContent = ''; });
                            th.setAttribute('data-sort', asc ? 'asc' : 'desc');
                            const indicator = th.querySelector('.sort-indicator');
                            if (indicator) indicator.textContent = asc ? ' ▲' : ' ▼';

                            rows.sort((a, b) => {
                                const aCell = a.children[colIndex] ? a.children[colIndex].innerText : '';
                                const bCell = b.children[colIndex] ? b.children[colIndex].innerText : '';
                                const aVal = parseCellValue(aCell, type);
                                const bVal = parseCellValue(bCell, type);
                                if (typeof aVal === 'number' && typeof bVal === 'number') {
                                    return asc ? aVal - bVal : bVal - aVal;
                                }
                                if (typeof aVal === 'string' && typeof bVal === 'string') {
                                    return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                }
                                return 0;
                            });

                            // reattach rows
                            rows.forEach(r => tbody.appendChild(r));
                        });
                    });
                }
        });

        async function loadDetailedData(type) {
            try {
                const response = await fetch(`@Url.Action("GetDetailedOverdueData", "Librarian")?type=${type}&daysRange=@Model.DaysRange`);
                const result = await response.json();
                
                if (result.success) {
                    currentDetailedType = type;
                    currentDetailedItems = result.data.data;
                    currentDetailedTitle = result.data.type;
                    displayDetailedData(result.data, type);
                } else {
                }
            } catch (error) {
            }
        }

        // Filter the Overdue Books table by month range
        function filterOverdueBooksTable() {
            try {
                const fromInput = document.getElementById('overdueBooksFrom');
                const toInput = document.getElementById('overdueBooksTo');
                const fromVal = fromInput && fromInput.value ? new Date(fromInput.value + '-01') : null;
                const toVal = toInput && toInput.value ? new Date(toInput.value + '-01') : null;
                if (toVal) {
                    // move to last day of month
                    toVal.setMonth(toVal.getMonth() + 1);
                    toVal.setDate(0);
                }

                const table = document.getElementById('overdueBooksListTable');
                if (!table) return;
                const tbody = table.tBodies[0];
                if (!tbody) return;
                const rows = Array.from(tbody.querySelectorAll('tr'));

                rows.forEach(row => {
                    try {
                        const dueCell = row.children[2];
                        const text = dueCell ? dueCell.innerText.trim() : '';
                        let due = Date.parse(text);
                        if (isNaN(due)) {
                            // try parsing MMM dd, yyyy
                            const parts = text.split(/\s+/);
                            if (parts.length >= 3) {
                                due = Date.parse(text);
                            }
                        }
                        const show = (function() {
                            if (!fromVal && !toVal) return true;
                            if (isNaN(due)) return false;
                            const d = new Date(due);
                            if (fromVal && d < fromVal) return false;
                            if (toVal && d > toVal) return false;
                            return true;
                        })();
                        row.style.display = show ? '' : 'none';
                    } catch (e) {
                        console.error('Error filtering overdue book row', e);
                    }
                });
            } catch (err) {
                console.error('Error in filterOverdueBooksTable:', err);
                alert('An error occurred while filtering overdue books. Check console for details.');
            }
        }

        function resetOverdueBooksTable() {
            try {
                const fromInput = document.getElementById('overdueBooksFrom');
                const toInput = document.getElementById('overdueBooksTo');
                if (fromInput) fromInput.value = '';
                if (toInput) toInput.value = '';
                const table = document.getElementById('overdueBooksListTable');
                if (!table) return;
                const tbody = table.tBodies[0];
                if (!tbody) return;
                Array.from(tbody.querySelectorAll('tr')).forEach(r => r.style.display = '');
            } catch (err) {
                console.error('Error resetting overdue books table:', err);
            }
        }

        // Wire filter buttons for overdue books once DOM is ready
        try {
            const btnFilterBooks = document.getElementById('btnFilterOverdueBooks');
            if (btnFilterBooks) btnFilterBooks.addEventListener('click', function() { try { filterOverdueBooksTable(); } catch(e){console.error(e);} });
            const btnResetBooks = document.getElementById('btnResetOverdueBooks');
            if (btnResetBooks) btnResetBooks.addEventListener('click', function() { try { resetOverdueBooksTable(); } catch(e){console.error(e);} });
            // expose
            window.filterOverdueBooksTable = filterOverdueBooksTable;
            window.resetOverdueBooksTable = resetOverdueBooksTable;
        } catch (ex) {
            console.error('Error wiring overdue books filter buttons:', ex);
        }

        function displayDetailedData(data, type) {
            const title = data.type;
            const items = data.data;
            
            const detailedDataSection = document.getElementById('detailedDataSection');
            const detailedDataTitle = document.getElementById('detailedDataTitle');
            const detailedDataTable = document.getElementById('detailedDataTable');
            
            detailedDataTitle.textContent = title;
            detailedDataTable.innerHTML = createTable(items, type);
            detailedDataSection.style.display = 'block';
            
            detailedDataSection.scrollIntoView({ behavior: 'smooth' });
        }

        function createTable(items, type) {
            if (!items || items.length === 0) {
                return '<p>No data available for the selected period.</p>';
            }

            // Sort items by date descending (newest first)
            const sortedItems = [...items].sort((a, b) => {
                let aDate = null, bDate = null;
                if (type === 'overdueaccounts' || type === 'totalfees') {
                    // Sort by earliest due date or max days overdue
                    aDate = a.maxDaysOverdue ? new Date(Date.now() - (a.maxDaysOverdue * 24 * 60 * 60 * 1000)) : null;
                    bDate = b.maxDaysOverdue ? new Date(Date.now() - (b.maxDaysOverdue * 24 * 60 * 60 * 1000)) : null;
                } else if (type === 'overduebooks') {
                    aDate = Date.parse(a.dueDate || 0);
                    bDate = Date.parse(b.dueDate || 0);
                }
                if (!aDate || isNaN(aDate)) return 1;
                if (!bDate || isNaN(bDate)) return -1;
                return bDate - aDate; // newest first
            });

            let table = '<table class="table table-striped table-hover">';
            
            if (type === 'overdueaccounts') {
                table += '<thead><tr><th>Student Name</th><th>Student Number</th><th>Overdue Books</th><th>Max Days Overdue</th><th>Total Fees</th><th>Status</th></tr></thead>';
                table += '<tbody>';
                sortedItems.forEach(item => {
                    table += '<tr>';
                    table += `<td>${item.studentName || 'N/A'}</td>`;
                    table += `<td>${item.studentNumber || 'N/A'}</td>`;
                    table += `<td><span class="badge badge-warning">${item.overdueBookCount || 0}</span></td>`;
                    table += `<td><span class="badge badge-danger">${item.maxDaysOverdue || 0} days</span></td>`;
                    table += `<td>₱${(item.totalFees || 0).toFixed(2)}</td>`;
                    table += `<td><span class="badge ${item.isRestricted ? 'badge-danger' : 'badge-success'}">${item.isRestricted ? 'Restricted' : 'Active'}</span></td>`;
                    table += '</tr>';
                });
            } else if (type === 'overduebooks') {
                table += '<thead><tr><th>Book Title</th><th>Author</th><th>Student Name</th><th>Student Number</th><th>Due Date</th><th>Days Overdue</th><th>Late Fee</th><th>Copy ID</th></tr></thead>';
                table += '<tbody>';
                sortedItems.forEach(item => {
                    table += '<tr>';
                    table += `<td>${item.bookTitle || 'N/A'}</td>`;
                    table += `<td>${item.bookAuthor || 'N/A'}</td>`;
                    table += `<td>${item.studentName || 'N/A'}</td>`;
                    table += `<td>${item.studentNumber || 'N/A'}</td>`;
                    table += `<td>${item.dueDate || 'N/A'}</td>`;
                    table += `<td><span class="badge badge-danger">${item.daysOverdue || 0} days</span></td>`;
                    table += `<td>₱${(item.lateFee || 0).toFixed(2)}</td>`;
                    table += `<td>${item.copyIdentifier || 'N/A'}</td>`;
                    table += '</tr>';
                });
            } else if (type === 'totalfees') {
                table += '<thead><tr><th>Student Name</th><th>Student Number</th><th>Overdue Books</th><th>Total Late Fees</th><th>Status</th></tr></thead>';
                table += '<tbody>';
                sortedItems.forEach(item => {
                    table += '<tr>';
                    table += `<td>${item.studentName || 'N/A'}</td>`;
                    table += `<td>${item.studentNumber || 'N/A'}</td>`;
                    table += `<td><span class="badge badge-warning">${item.overdueBookCount || 0}</span></td>`;
                    table += `<td><strong>₱${(item.totalFees || 0).toFixed(2)}</strong></td>`;
                    table += `<td><span class="badge ${item.isRestricted ? 'badge-danger' : 'badge-success'}">${item.isRestricted ? 'Restricted' : 'Active'}</span></td>`;
                    table += '</tr>';
                });
            }
            
            table += '</tbody></table>';
            return table;
        }

        function filterByDateRange(days) {
            window.location.href = '@Url.Action("Overdue", "Librarian")?daysRange=' + days;
        }

    // Show sections only when stats are clicked
    document.addEventListener('DOMContentLoaded', function () {
        const stats = document.querySelectorAll('.clickable-stat');
        const accountsSection = document.getElementById('overdueAccountsSection');
        const booksSection = document.getElementById('overdueBooksSection');

        stats.forEach(stat => {
            stat.addEventListener('click', function () {
                const type = this.dataset.type;
                if (type === 'overdueaccounts') {
                    accountsSection.style.display = 'block';
                    booksSection.style.display = 'none';
                    accountsSection.scrollIntoView({ behavior: 'smooth' });
                } else if (type === 'overduebooks') {
                    booksSection.style.display = 'block';
                    accountsSection.style.display = 'none';
                    booksSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    });

        function searchOverdueAccounts() {
            const input = document.getElementById('searchOverdue').value.toLowerCase();
            const rows = document.querySelectorAll('.overdue-row');

            rows.forEach(row => {
                const student = row.dataset.student;
                const number = row.dataset.number;
                const match = student.includes(input) || number.includes(input);
                row.dataset.hiddenBySearch = (!match).toString();
            });

            filterOverdueAccountsTable();
        }

        function filterByStatus() {
            const statusFilter = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('.overdue-row');

            rows.forEach(row => {
                const isRestricted = row.querySelector('.restricted') !== null;
                let show = true;

                if (statusFilter === 'restricted') {
                    show = isRestricted;
                } else if (statusFilter === 'active') {
                    show = !isRestricted;
                }

                row.dataset.hiddenByStatus = (!show).toString();
            });

            filterOverdueAccountsTable();
        }

        function filterOverdueAccountsTable() {
            const fromVal = document.getElementById('overdueTableFrom')?.value;
            const toVal = document.getElementById('overdueTableTo')?.value;
        const fromDate = fromVal ? new Date(fromVal + '-01') : null;
        const toDate = toVal ? new Date(toVal + '-01') : null;
        if (toDate) { toDate.setMonth(toDate.getMonth() + 1); toDate.setDate(0); }

            document.querySelectorAll('.overdue-row').forEach(row => {
                const searchHidden = row.dataset.hiddenBySearch === 'true';
                const statusHidden = row.dataset.hiddenByStatus === 'true';

                // Determine visibility based on whether any overdue book for this account falls within the selected month range.
                // Use serialized data-overdue-books JSON (array with DueDate properties) for accurate filtering.
                let dateHidden = false;
                try {
                    const raw = row.getAttribute('data-overdue-books');
                    const books = raw ? JSON.parse(raw) : [];

                    if ((fromDate || toDate) && books && books.length > 0) {
                        // If none of the overdue books have a due date inside the range, hide the row
                        const anyInRange = books.some(b => {
                            if (!b || !b.DueDate) return false;
                            // Try to parse various possible formats
                            const parsed = Date.parse(b.DueDate);
                            let d = null;
                            if (!isNaN(parsed)) d = new Date(parsed);
                            else {
                                // try YYYY-MM-DD or MM/dd/yyyy
                                const parts = (b.DueDate || '').split(/[-/]/);
                                if (parts.length === 3) {
                                    // if year first
                                    if (parts[0].length === 4) {
                                        d = new Date(parseInt(parts[0],10), parseInt(parts[1],10)-1, parseInt(parts[2],10));
                                    } else {
                                        // assume MM/DD/YYYY
                                        d = new Date(parseInt(parts[2],10), parseInt(parts[0],10)-1, parseInt(parts[1],10));
                                    }
                                }
                            }
                            if (!d) return false;
                            if (fromDate && d < fromDate) return false;
                            if (toDate && d > toDate) return false;
                            return true;
                        });

                        dateHidden = !anyInRange;
                    } else {
                        // if no range selected, don't hide by date
                        dateHidden = false;
                    }
                } catch (e) {
                    // fallback: if parsing fails and a range is specified, hide the row
                    dateHidden = (fromDate || toDate) ? true : false;
                }

                const hide = searchHidden || statusHidden || dateHidden;
                row.style.display = hide ? 'none' : '';
            });

            // Also filter the Overdue Books table (if present) by Due Date month range
            try {
                const booksTable = document.getElementById('overdueBooksTable');
                if (booksTable) {
                    const rows = Array.from(booksTable.querySelectorAll('tbody tr'));
                    rows.forEach(r => {
                        const dueText = r.children[2] ? r.children[2].innerText.trim() : '';
                        let hide = false;
                        if ((fromDate || toDate) && dueText) {
                            // Try parse using Date.parse or MM/dd/yyyy formats
                            let d = Date.parse(dueText);
                            if (isNaN(d)) {
                                const parts = dueText.split('/');
                                if (parts.length === 3) {
                                    d = Date.parse(`${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`);
                                } else {
                                    // try MMM dd, yyyy
                                    d = Date.parse(dueText);
                                }
                            }
                            if (isNaN(d)) {
                                hide = true;
                            } else {
                                const dt = new Date(d);
                                if (fromDate && dt < fromDate) hide = true;
                                if (toDate && dt > toDate) hide = true;
                            }
                        }
                        r.style.display = hide ? 'none' : '';
                    });
                }
            } catch (e) {
                console.log('Error filtering overdue books table:', e);
            }
        }

        function resetOverdueAccountsTable() {
            const f = document.getElementById('overdueTableFrom'); if (f) f.value = '';
            const t = document.getElementById('overdueTableTo'); if (t) t.value = '';
            document.querySelectorAll('.overdue-row').forEach(r => {
                r.dataset.hiddenBySearch = 'false';
                r.dataset.hiddenByStatus = 'false';
                r.style.display = '';
            });
            // reset overdue books table if present
            try {
                const booksTable = document.getElementById('overdueBooksTable');
                if (booksTable) {
                    Array.from(booksTable.querySelectorAll('tbody tr')).forEach(r => r.style.display = '');
                }
            } catch (e) { console.log(e); }
        }

        function showOverdueBooks(studentName, books) {
            currentStudentName = studentName;
            currentOverdueBooks = books;

            document.getElementById('detailsStudentName').textContent = studentName + "'s Overdue Books";

            let html = '<table style="width: 100%; margin-top: 20px;"><thead><tr><th>Book Title</th><th>Due Date</th><th>Days Overdue</th><th>Late Fee</th></tr></thead><tbody>';

            books.forEach(book => {
                html += `<tr>
                    <td>${book.bookTitle}</td>
                    <td>${new Date(book.dueDate).toLocaleDateString()}</td>
                    <td>${book.daysOverdue} days</td>
                    <td>₱${book.lateFee.toFixed(2)}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('overdueBooksList').innerHTML = html;
            document.getElementById('overdueDetailsModal').style.display = 'flex';
        }

        function closeOverdueDetails() {
            document.getElementById('overdueDetailsModal').style.display = 'none';
            currentStudentName = '';
            currentOverdueBooks = [];
        }

        function showUnrestrictPopup(userId, studentName, buttonElement) {
            if (buttonElement && buttonElement.disabled) {
                return;
            }
            
            clickedButton = buttonElement;
            selectedUserId = userId;
            document.getElementById('unrestrictStudentName').textContent = studentName;
            const modal = document.getElementById('confirmUnrestrictPopup');

            if (modal) {
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                modal.style.zIndex = '99999';
                modal.style.justifyContent = 'center';
                modal.style.alignItems = 'center';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'all';
            }
        }

        function closeUnrestrictPopup() {
            document.getElementById('confirmUnrestrictPopup').style.display = 'none';
            selectedUserId = null;
            clickedButton = null;
        }

        async function confirmUnrestrict() {
            if (!selectedUserId) {
                alert('No user selected');
                return;
            }

            if (clickedButton) {
                clickedButton.disabled = true;
                clickedButton.style.opacity = '0.6';
                clickedButton.style.cursor = 'not-allowed';
            }

            try {
                const formData = new FormData();
                formData.append('userId', selectedUserId);

                const response = await fetch('/Librarian/UnrestrictUser', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    if (clickedButton) {
                        clickedButton.textContent = 'Requested ✓';
                        clickedButton.style.opacity = '0.6';
                        clickedButton.style.cursor = 'not-allowed';
                        clickedButton.classList.remove('active');
                        clickedButton.classList.add('disabled');
                    }

                    closeUnrestrictPopup();
                    const successModal = document.getElementById('successUnrestrictPopup');
                    if (successModal) {
                        successModal.style.display = 'flex';
                        successModal.style.position = 'fixed';
                        successModal.style.top = '0';
                        successModal.style.left = '0';
                        successModal.style.right = '0';
                        successModal.style.bottom = '0';
                        successModal.style.width = '100vw';
                        successModal.style.height = '100vh';
                        successModal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                        successModal.style.zIndex = '99999';
                        successModal.style.justifyContent = 'center';
                        successModal.style.alignItems = 'center';
                        successModal.style.visibility = 'visible';
                        successModal.style.opacity = '1';
                        successModal.style.pointerEvents = 'all';
                    }
                } else {
                    alert('Error: ' + result.message);
                    if (clickedButton) {
                        clickedButton.disabled = false;
                        clickedButton.style.opacity = '1';
                        clickedButton.style.cursor = 'pointer';
                    }
                }
            } catch (error) {
                console.error('Error unrestricting user:', error);
                alert('An error occurred while unrestricting the user');
                if (clickedButton) {
                    clickedButton.disabled = false;
                    clickedButton.style.opacity = '1';
                    clickedButton.style.cursor = 'pointer';
                }
            }
        }

        function closeSuccessPopup() {
            document.getElementById('successUnrestrictPopup').style.display = 'none';
        }

        // PDF Export Functions
        function exportMainTableToPDF() {
            const exportBtn = document.getElementById('exportMainTableBtn');
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span>Generating PDF...</span>';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');

                const rows = Array.from(document.querySelectorAll('.overdue-row'))
                    .filter(row => row.style.display !== 'none');

                if (rows.length === 0) {
                    alert('No data available to export');
                    return;
                }

                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Overdue Accounts Report', 14, 15);

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const dateRange = document.getElementById('overdueFilter').selectedOptions[0].text;
                const generatedDate = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text(`Date Range: ${dateRange}`, 14, 22);
                doc.text(`Generated: ${generatedDate}`, 14, 27);
                doc.text(`Total Records: ${rows.length}`, 14, 32);

                doc.text(`Total Overdue Accounts: @Model.TotalOverdueAccounts`, 14, 37);
                doc.text(`Total Overdue Books: @Model.TotalOverdueBooks`, 90, 37);
                doc.text(`Total Fees: ₱@Model.TotalFees.ToString("N2")`, 160, 37);

                const tableData = rows.map(row => [
                    row.dataset.studentName || 'N/A',
                    row.dataset.overdueCount || '0',
                    row.dataset.daysOverdue || '0',
                    row.dataset.status || 'N/A'
                ]);

                doc.autoTable({
                    head: [['Student Name', 'Overdue Books', 'Days Overdue', 'Status']],
                    body: tableData,
                    startY: 43,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [239, 68, 68],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 10
                    }
                        ,styles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { cellWidth: 80 },
                            1: { cellWidth: 40, halign: 'center' },
                            2: { cellWidth: 40, halign: 'center' },
                            3: { cellWidth: 30, halign: 'center' }
                        },
                        margin: { top: 43, left: 14, right: 14 },
                        didDrawPage: function(data) {
                            // Footer
                            doc.setFontSize(8);
                            doc.setTextColor(128);
                            const pageCount = doc.internal.getNumberOfPages();
                            doc.text(
                                `Page ${data.pageNumber} of ${pageCount}`,
                                doc.internal.pageSize.width / 2,
                                doc.internal.pageSize.height - 10,
                                { align: 'center' }
                            );
                        }
                    });

                    doc.save(`Overdue_Accounts_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export as PDF
                    `;
                }
            }

            function exportDetailsToPDF() {
                const exportBtn = document.getElementById('exportDetailsBtn');
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<span>Generating PDF...</span>';

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');

                    if (!currentOverdueBooks || currentOverdueBooks.length === 0) {
                        alert('No data available to export');
                        return;
                    }

                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${currentStudentName}'s Overdue Books`, 14, 15);

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const generatedDate = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    doc.text(`Generated: ${generatedDate}`, 14, 22);
                    doc.text(`Total Books: ${currentOverdueBooks.length}`, 14, 27);

                    const totalFees = currentOverdueBooks.reduce((sum, book) => sum + book.lateFee, 0);
                    doc.text(`Total Late Fees: ₱${totalFees.toFixed(2)}`, 14, 32);

                    const tableData = currentOverdueBooks.map(book => [
                        book.bookTitle || 'N/A',
                        new Date(book.dueDate).toLocaleDateString() || 'N/A',
                        `${book.daysOverdue || 0} days`,
                        `₱${(book.lateFee || 0).toFixed(2)}`
                    ]);

                    doc.autoTable({
                        head: [['Book Title', 'Due Date', 'Days Overdue', 'Late Fee']],
                        body: tableData,
                        startY: 38,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [66, 133, 244],
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 10
                        },
                        styles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        columnStyles: {
                            0: { cellWidth: 120 },
                            1: { cellWidth: 40, halign: 'center' },
                            2: { cellWidth: 40, halign: 'center' },
                            3: { cellWidth: 30, halign: 'right' }
                        },
                        margin: { top: 38, left: 14, right: 14 },
                        didDrawPage: function(data) {
                            // Footer
                            doc.setFontSize(8);
                            doc.setTextColor(128);
                            const pageCount = doc.internal.getNumberOfPages();
                            doc.text(
                                `Page ${data.pageNumber} of ${pageCount}`,
                                doc.internal.pageSize.width / 2,
                                doc.internal.pageSize.height - 10,
                                { align: 'center' }
                            );
                        }
                    });

                    doc.save(`${currentStudentName}_Overdue_Books_${new Date().toISOString().split('T')[0]}.pdf`);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export as PDF
                    `;
                }
            }

            function exportDetailedDataToPDF() {
                const exportBtn = document.getElementById('exportDetailedDataBtn');
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<span>Generating PDF...</span>';

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');

                    if (!currentDetailedItems || currentDetailedItems.length === 0) {
                        alert('No data available to export');
                        return;
                    }

                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text(currentDetailedTitle, 14, 15);

                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const dateRange = document.getElementById('overdueFilter').selectedOptions[0].text;
                    const generatedDate = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    doc.text(`Date Range: ${dateRange}`, 14, 22);
                    doc.text(`Generated: ${generatedDate}`, 14, 27);
                    doc.text(`Total Records: ${currentDetailedItems.length}`, 14, 32);

                    let tableData = [];
                    let headers = [];

                    if (currentDetailedType === 'overdueaccounts') {
                        headers = ['Student Name', 'Student Number', 'Overdue Books', 'Max Days Overdue', 'Total Fees', 'Status'];
                        tableData = currentDetailedItems.map(item => [
                            item.studentName || 'N/A',
                            item.studentNumber || 'N/A',
                            (item.overdueBookCount || 0).toString(),
                            `${item.maxDaysOverdue || 0} days`,
                            `₱${(item.totalFees || 0).toFixed(2)}`,
                            item.isRestricted ? 'Restricted' : 'Active'
                        ]);
                    } else if (currentDetailedType === 'overduebooks') {
                        headers = ['Book Title', 'Author', 'Student Name', 'Student Number', 'Due Date', 'Days Overdue', 'Late Fee'];
                        tableData = currentDetailedItems.map(item => [
                            item.bookTitle || 'N/A',
                            item.bookAuthor || 'N/A',
                            item.studentName || 'N/A',
                            item.studentNumber || 'N/A',
                            item.dueDate || 'N/A',
                            `${item.daysOverdue || 0} days`,
                            `₱${(item.lateFee || 0).toFixed(2)}`
                        ]);
                    } else if (currentDetailedType === 'totalfees') {
                        headers = ['Student Name', 'Student Number', 'Overdue Books', 'Total Late Fees', 'Status'];
                        tableData = currentDetailedItems.map(item => [
                            item.studentName || 'N/A',
                            item.studentNumber || 'N/A',
                            (item.overdueBookCount || 0).toString(),
                            `₱${(item.totalFees || 0).toFixed(2)}`,
                            item.isRestricted ? 'Restricted' : 'Active'
                        ]);
                    }

                    doc.autoTable({
                        head: [headers],
                        body: tableData,
                        startY: 38,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [66, 133, 244],
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 9
                        },
                        styles: {
                            fontSize: 8,
                            cellPadding: 2
                        },
                        margin: { top: 38, left: 14, right: 14 },
                        didDrawPage: function(data) {
                            // Footer
                            doc.setFontSize(8);
                            doc.setTextColor(128);
                            const pageCount = doc.internal.getNumberOfPages();
                            doc.text(
                                `Page ${data.pageNumber} of ${pageCount}`,
                                doc.internal.pageSize.width / 2,
                                doc.internal.pageSize.height - 10,
                                { align: 'center' }
                            );
                        }
                    });

                    const filename = `${currentDetailedTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(filename);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    exportBtn.disabled = false
                    exportBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export as PDF
                    `;
                }
            }
        </script>
}