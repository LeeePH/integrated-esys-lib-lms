@model List<SystemLibrary.Models.Book>
@{
    ViewData["Title"] = "Catalog Management";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/catalogs.css" />

<!-- Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert">&times;</button>
                </div>
}
@if (TempData["ErrorMessage"] != null)
{
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert">&times;</button>
                </div>
}

<div class="catalog-container">
    <h1 class="catalog-title">Catalog Management</h1>

    <!-- HEADER -->
    <div class="catalog-header">
        <div class="catalog-searchbar">
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="Search..." class="catalog-search-input" onkeyup="searchBooks()" />
                <img src="~/images/searchicon.png" alt="Search" class="search-icon" />
            </div>

            <button class="catalog-filter-btn" onclick="toggleFilter()">
                <img src="~/images/filler.png" alt="Filter" class="filter-icon" />
            </button>

            <select id="statusFilter" class="catalog-dropdown" onchange="filterBooks()">
                <option value="">All</option>
                <option value="available">Available</option>
                <option value="unavailable">Borrowed</option>
            </select>
        </div>

        <button class="catalog-add-btn" onclick="showAddBookModal()">
            <img src="~/images/plusmark.png" alt="Add" class="add-icon" />
            Add New Book
        </button>

    </div>

    <!-- Filter Panel -->
    <div id="filterPanel" class="filter-panel" style="display: none;">
        <select id="subjectFilter" onchange="filterBooks()">
            <option value="">All Subjects</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Mathematics">Mathematics</option>
            <option value="Physics">Physics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Biology">Biology</option>
            <option value="Engineering">Engineering</option>
            <option value="Literature">Literature</option>
            <option value="History">History</option>
            <option value="Philosophy">Philosophy</option>
            <option value="Business">Business</option>
            <option value="Other">Other</option>
        </select>
    </div>

    <!-- TABLE -->
    <div class="catalog-table-wrapper">
        <table class="catalog-table">
            <thead>
                <tr>
                    <th>Book Details</th>
                    <th>Location</th>
                    <th>Availability</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var book in Model)
                    {
                                                <tr class="book-row" data-subject="@book.Subject" data-status="@((!book.IsActive) ? "inactive" : (book.IsAvailable ? "available" : "unavailable"))">
                                                    <td>
                                                        <div class="catalog-bookinfo">
                                                            <div class="catalog-booktitle">
                                                                <img src="~/images/bookmark.png" alt="Book" class="mark-icon" />
                                                                <strong>@book.Title</strong>
                                                            </div>
                                                            <p>@book.Author</p>
                                                            <p>ISBN: @book.ISBN</p>
                                                            <p>@book.Subject</p>
                                                        </div>
                                                    </td>
                                                    <td>IT - 001 - A3</td>
                                                    <td>
                                                        <div class="availability-container">
                                                            <strong>@book.AvailableCopies / @book.TotalCopies</strong>
                                                            @if (book.CopyManagementEnabled)
                                                            {
                                                                <button class="copy-details-btn" onclick="showCopyDetails('@book._id')" title="View Individual Copy Details">
                                                                    <i class="fas fa-list"></i> View Copies
                                                                </button>
                                                            }
                                                        </div>
                                                    </td>
                                                    <td>
                                @if (!book.IsActive)
                                {
                                                                        <span class="catalog-status catalog-status-unavailable">Inactive</span>
                                }
                                else if (book.IsAvailable)
                                {
                                                                        <span class="catalog-status catalog-status-available">Available - @book.AvailableCopies</span>
                                }
                                else
                                {
                                                                        <span class="catalog-status catalog-status-unavailable">Not Available</span>
                                }
                                                    </td>
                                                    <td>
                                        <button class ="catalog-update-btn"onclick="showEditBookModal(
            '@book._id',
            '@book.Title',
            '@book.Author',
            '@book.ISBN',
            '@book.Publisher',
            '@book.ClassificationNo',
            '@book.Subject',
         '@book.PublicationDate',
             '@book.Restrictions',
            '@book.Image',
            @book.TotalCopies,
            @book.BorrowedCopies,
            '@book.CreatedAt',
            @book.IsActive.ToString().ToLower(),
            @book.IsReferenceOnly.ToString().ToLower()

        )">
                                            UPDATE
                                        </button>

                                                    </td>
                                                </tr>
                    }
                }
                else
                {
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <p>No books in catalog</p>
                                    </td>
                                </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- ADD BOOK MODAL -->
<div class="addbook-modal" id="addBookModal">
    <div class="addbook-content">
        <div class="addbook-header">ADD BOOK</div>
        <div class="addbook-body">
            <!-- MOCK data Lookup Section -->
            <div class="mac-lookup-section">
                <h3>üîç MOCK data Lookup</h3>
                <div class="lookup-controls">
                    <div class="lookup-group">
                        <select id="macLookupTypeL" class="lookup-select">
                            <option value="isbn">Lookup by ISBN</option>
                            <option value="author">Lookup by Author</option>
                        </select>
                        <input type="text" id="macLookupValueL" placeholder="Enter ISBN or Author" class="catalog-search-input lookup-input" />
                        <button type="button" class="catalog-add-btn" onclick="lookupMacForBookL()">Lookup</button>
                    </div>
                    <div id="macLookupResultL" class="lookup-result"></div>
                    
                </div>
            </div>
            <form asp-controller="Librarian" asp-action="AddBook" method="post" enctype="multipart/form-data" onsubmit="return validateAddForm()" id="addBookForm">
                @Html.AntiForgeryToken()

                <!-- Title -->
                <label>Title *</label>
                <input type="text" name="Title" id="addTitle" placeholder="Book Title..." required>

                <!-- Author -->
                <label>Author *</label>
                <input type="text" name="Author" id="addAuthor" placeholder="Book Author..." required>

                <div class="addbook-row">
                    <div class="addbook-col">
                        <!-- ISBN -->
                        <label>ISBN</label>
                        <input type="text" name="ISBN" id="addISBN" placeholder="978-0134685991">
                    </div>
                    <div class="addbook-col">
                        <!-- Subject -->
                        <label>Subject *</label>
                        <select name="Subject" id="addSubject" required>
                            <option value="">Select Subject</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Literature">Literature</option>
                            <option value="History">History</option>
                            <option value="Philosophy">Philosophy</option>
                            <option value="Business">Business</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="addbook-row">
                    <div class="addbook-col">
                        <!-- Publisher -->
                        <label>Publisher</label>
                        <input type="text" name="Publisher" id="addPublisher" placeholder="Publisher Name...">
                    </div>
                    <div class="addbook-col">
                        <!-- Publication Date -->
                        <label>Publication Date</label>
                        <input type="date" name="PublicationDate" id="addPublicationDate" value="@DateTime.UtcNow.ToString("yyyy-MM-dd")">
                    </div>
                </div>

                <div class="addbook-row">
                    <div class="addbook-col">
                        <!-- Classification Number -->
                        <label>Classification No.</label>
                        <input type="text" name="ClassificationNo" id="addClassificationNo" placeholder="IT-001-A3" value="IT-001-A3">
                    </div>
                    <div class="addbook-col">
                        <!-- Quantity / Total Copies -->
                        <label>Quantity *</label>
                        <input type="number" name="TotalCopies" id="addQuantity" min="1" value="1" required>
                    </div>
                </div>

                <!-- Copy Management Section for Add -->
                <div class="copy-management-section">
                    <div class="copy-management-header">
                        <h4>üìö Copy Management</h4>
                        <label class="copy-toggle">
                            <input type="hidden" name="CopyManagementEnabled" value="false">
                            <input type="checkbox" id="addEnableCopyManagement" name="CopyManagementEnabled" value="true" onchange="toggleAddCopyManagement()">
                            Enable Individual Copy Tracking
                        </label>
                    </div>
                    
                    <div id="addCopyManagementOptions" style="display: none;">
                        <div class="addbook-row">
                            <div class="addbook-col">
                                <label>Copy ID Prefix</label>
                                <input type="text" name="CopyPrefix" id="addCopyPrefix" placeholder="SDS" value="SDS" maxlength="4" onchange="updateAddCopyPreview()">
                                <small>Prefix for copy IDs (e.g., SDS-0232)</small>
                            </div>
                            <div class="addbook-col">
                                <label>Starting Copy Number</label>
                                <input type="number" name="NextCopyNumber" id="addNextCopyNumber" min="1" value="1" onchange="updateAddCopyPreview()">
                                <small>First copy number (e.g., 1 for SDS-0001)</small>
                            </div>
                        </div>
                        
                        <div class="copy-preview">
                            <strong>Preview Copy IDs:</strong>
                            <div id="addCopyIdPreview" class="copy-id-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Restrictions -->
                <label>Restrictions (optional)</label>
                <textarea name="Restrictions" id="addRestrictions" placeholder="Optional restrictions..."></textarea>

                <!-- Reference Only -->
                <div class="status-toggle-section">
                    <label>Reference Only</label>
                    <div class="toggle-switch">
                        <input type="hidden" name="IsReferenceOnly" value="false">
                        <input type="checkbox" id="addIsReferenceOnly" name="IsReferenceOnly" value="true">
                        <label for="addIsReferenceOnly" class="toggle-label">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">For Reference (non-borrowable)</span>
                        </label>
                    </div>
                </div>

                <!-- Image Upload -->
                <label>Image</label>
                <div class="addbook-image-box" onclick="document.getElementById('addBookImage').click()">
                    <span id="addImageText">Click to Upload Image</span>
                    <img id="addImagePreview" src="" alt="" style="display:none; max-width: 100%; max-height: 150px; margin-top: 10px;">
                </div>
                <input type="file" id="addBookImage" name="bookImage" accept="image/*" style="display:none;" onchange="previewImage(this, 'add')">

                <!-- Buttons -->
                <div class="addbook-buttons">
                    <button type="button" class="addbook-cancel" onclick="closeAddBookModal()">Cancel</button>
                    <button type="submit" class="addbook-save" id="addBookSubmitBtn">+ Save Book</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- UPDATE BOOK MODAL -->
<div class="addbook-modal" id="updateBookModal">
    <div class="addbook-content">
        <div class="addbook-header">UPDATE BOOK</div>
        <div class="addbook-body">
            <div id="updateInfoCard" class="info-card" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: none;">
                <p><strong>Available Copies:</strong> <span id="updateAvailableCopies"></span></p>
                <p><strong>Borrowed Copies:</strong> <span id="updateBorrowedCopies"></span></p>
                <div id="updateBorrowWarning" class="alert-warning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; padding: 0.75rem; border-radius: 4px; margin-top: 0.5rem;">
                    ‚ö†Ô∏è This book has borrowed copies. Be careful when reducing total copies.
                </div>
            </div>

            <form id="updateBookForm" asp-controller="Librarian" asp-action="EditBook" method="post" enctype="multipart/form-data" onsubmit="return validateUpdateForm()">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="updateBookId" />
                <input type="hidden" name="_id" id="update_Id" />
                <input type="hidden" id="updateCurrentImage" name="Image" />

                <label>Title *</label>
                <input type="text" name="Title" id="updateTitle" placeholder="Book Title..." required>

                <label>Author *</label>
                <input type="text" name="Author" id="updateAuthor" placeholder="Book Author..." required>

                <div class="addbook-row">
                    <div class="addbook-col">
                        <label>ISBN</label>
                        <input type="text" name="ISBN" id="updateISBN" placeholder="978-0134685991">
                    </div>
                    <div class="addbook-col">
                        <label>Subject *</label>
                        <select name="Subject" id="updateSubject" required>
                            <option value="">Select Subject</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="Biology">Biology</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Literature">Literature</option>
                            <option value="History">History</option>
                            <option value="Philosophy">Philosophy</option>
                            <option value="Business">Business</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="addbook-row">
                    <div class="addbook-col">
                        <label>Publisher</label>
                        <input type="text" name="Publisher" id="updatePublisher" placeholder="Publisher Name...">
                    </div>
                    <div class="addbook-col">
                        <label>Publication Date</label>
                        <input type="date" name="PublicationDate" id="updatePublicationDate" >
                    </div>
                </div>

                <div class="addbook-row">
                    <div class="addbook-col">
                        <label>Classification No.</label>
                        <input type="text" name="ClassificationNo" id="updateClassificationNo" placeholder="IT-001-A3">
                    </div>
                    <div class="addbook-col">
                        <label>Quantity *</label>
                        <input type="number" name="TotalCopies" id="updateQuantity" min="1" value="1" required onchange="updateAvailablePreview(); updateCopyPreview()">
                        <small id="minCopiesWarning" style="color: #666; font-size: 0.85rem;"></small>
                        <div id="availablePreview" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                    </div>
                </div>

                <!-- Copy Management Section for Update -->
                <div class="copy-management-section">
                    <div class="copy-management-header">
                        <h4>üìö Copy Management</h4>
                        <label class="copy-toggle">
                            <input type="hidden" name="CopyManagementEnabled" value="false">
                            <input type="checkbox" id="updateEnableCopyManagement" name="CopyManagementEnabled" value="true" onchange="toggleUpdateCopyManagement()">
                            Enable Individual Copy Tracking
                        </label>
                    </div>
                    
                    <div id="updateCopyManagementOptions" style="display: none;">
                        <div class="addbook-row">
                            <div class="addbook-col">
                                <label>Copy ID Prefix</label>
                                <input type="text" name="CopyPrefix" id="updateCopyPrefix" placeholder="SDS" value="SDS" maxlength="4" onchange="updateCopyPreview()">
                                <small>Prefix for copy IDs (e.g., SDS-0232)</small>
                            </div>
                            <div class="addbook-col">
                                <label>Starting Copy Number</label>
                                <input type="number" name="NextCopyNumber" id="updateNextCopyNumber" min="1" value="1" onchange="updateCopyPreview()">
                                <small>First copy number (e.g., 1 for SDS-0001)</small>
                            </div>
                        </div>
                        
                        <div class="copy-preview">
                            <strong>Preview Copy IDs:</strong>
                            <div id="updateCopyIdPreview" class="copy-id-list"></div>
                        </div>
                    </div>
                </div>

                <label>Restrictions (optional)</label>
                <textarea name="Restrictions" id="updateRestrictions"></textarea>

                <label>Image</label>
                <div class="addbook-image-box" onclick="document.getElementById('updateBookImage').click()">
                    <span id="updateImageText">Click to Change Image</span>
                    <img id="updateImagePreview" src="" alt="" style="display:none; max-width: 100%; max-height: 150px; margin-top: 10px;">
                </div>
                <input type="file" id="updateBookImage" name="bookImage" accept="image/*" style="display:none;" onchange="previewImage(this, 'update')">

                <!-- Reference Only (Update) -->
                <div class="status-toggle-section">
                    <label>Reference Only</label>
                    <div class="toggle-switch">
                        <input type="hidden" name="IsReferenceOnly" value="false">
                        <input type="checkbox" id="updateIsReferenceOnly" name="IsReferenceOnly" value="true">
                        <label for="updateIsReferenceOnly" class="toggle-label">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">For Reference (non-borrowable)</span>
                        </label>
                    </div>
                </div>

                <!-- Active/Inactive Status Toggle -->
                <div class="status-toggle-section">
                    <label>Book Status</label>
                    <div class="toggle-switch">
                        <input type="hidden" name="IsActive" value="false">
                        <input type="checkbox" id="updateIsActive" name="IsActive" value="true" checked>
                        <label for="updateIsActive" class="toggle-label">
                            <span class="toggle-slider"></span>
                            <span class="toggle-text" id="updateStatusText">Active</span>
                        </label>
                    </div>
                    <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 5px;">
                        Inactive books will not be available for borrowing
                    </small>
                </div>

                <div class="addbook-buttons">
                    <button type="button" class="addbook-cancel" onclick="closeUpdateBookModal()">Cancel</button>
                    <button type="submit" class="addbook-save" id="updateBookButton">Update Book</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SUCCESS UPDATE BOOK POPUP -->
<div class="action-popup" id="bookUpdatedPopup">
    <div class="popup-content success">
        <div class="popup-icon">
            <img src="~/images/bluecheck.png" alt="Success" />
        </div>
        <h2>Book Updated!</h2>
        <p>Book has been updated</p>
        <button class="popup-done" onclick="closePopup('bookUpdatedPopup')">DONE</button>
    </div>
</div>

<!-- SUCCESS UPDATE BOOK POPUP -->
<div class="action-popup" id="bookUpdatedPopup">
    <div class="popup-content success">
        <div class="popup-icon">
            <img src="~/images/bluecheck.png" alt="Success" />
        </div>
        <h2>Book Updated!</h2>
        <p>Book has been updated</p>
        <button class="popup-done" onclick="closePopup('bookUpdatedPopup')">DONE</button>
    </div>
</div>

<!-- CONFIRM DELETE POPUP -->
<div class="action-popup" id="confirmDeletePopup">
    <div class="popup-content delete">
        <div class="popup-icon">
            <img src="~/images/trashbin.png" alt="Delete" />
        </div>
        <h2>Are you sure you want to <strong>DELETE</strong> this book?</h2>
        <p id="deleteBookTitle" style="margin: 1rem 0; color: #666;"></p>
        <div class="popup-buttons">
            <button class="popup-no" onclick="closePopup('confirmDeletePopup')">NO</button>
            <button class="popup-yes" id="confirmDeleteBtn" onclick="executeDelete()">YES</button>
        </div>
    </div>
</div>

<!-- SUCCESS DELETE POPUP -->
<div class="action-popup" id="bookDeletedPopup">
    <div class="popup-content delete">
        <div class="popup-icon">
            <img src="~/images/trashbin.png" alt="Success" />
        </div>
        <h2>Book has been <strong>DELETED</strong> successfully</h2>
        <button class="popup-done" onclick="closePopup('bookDeletedPopup')">DONE</button>
    </div>
</div>

<!-- COPY DETAILS MODAL -->
<div class="copy-details-modal" id="copyDetailsModal">
    <div class="copy-details-content">
        <div class="copy-details-header">
            <h3 id="copyDetailsTitle">Copy Details</h3>
            <button class="copy-details-close" onclick="closeCopyDetailsModal()">&times;</button>
        </div>
        <div class="copy-details-body">
            <div id="copyDetailsInfo" class="copy-details-info">
                <p><strong>Book:</strong> <span id="copyBookTitle"></span></p>
                <p><strong>Author:</strong> <span id="copyBookAuthor"></span></p>
                <p><strong>ISBN:</strong> <span id="copyBookIsbn"></span></p>
                <p><strong>Total Copies:</strong> <span id="copyTotalCopies"></span></p>
            </div>
            <div class="copy-details-table-wrapper">
                <table class="copy-details-table">
                    <thead>
                        <tr>
                            <th>Copy ID</th>
                            <th>Barcode</th>
                            <th>Status</th>
                            <th>Condition</th>
                            <th>Location</th>
                            <th>Borrow Count</th>
                            <th>Last Borrowed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="copyDetailsTableBody">
                        <!-- Copy details will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<form id="deleteBookForm" asp-controller="Librarian" asp-action="DeleteBook" method="post" style="display: none;">
    <input type="hidden" id="deleteBookId" name="id" />
</form>

<script>
    let currentDeleteId = null;

    // Search functionality
    function searchBooks() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('.book-row');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(input) ? '' : 'none';
        });
    }

    // Filter functionality
    function toggleFilter() {
        const panel = document.getElementById('filterPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    function filterBooks() {
        const subjectFilter = document.getElementById('subjectFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const rows = document.querySelectorAll('.book-row');

        rows.forEach(row => {
            const subject = row.dataset.subject;
            const status = row.dataset.status;

            const subjectMatch = !subjectFilter || subject === subjectFilter;
            const statusMatch = !statusFilter || status === statusFilter;

            row.style.display = subjectMatch && statusMatch ? '' : 'none';
        });
    }

    // Add Book Modal
    function showAddBookModal() {
        document.getElementById('addBookModal').style.display = 'flex';
        document.getElementById('addImagePreview').style.display = 'none';
        document.getElementById('addImageText').style.display = 'block';
        document.getElementById('addImageText').textContent = 'Click to Upload Image';
        document.getElementById('addBookImage').value = '';
    }

    function closeAddBookModal() {
        document.getElementById('addBookModal').style.display = 'none';
        document.querySelector('#addBookModal form').reset();
    }

    function showEditBookModal(
        id,
        title,
        author,
        isbn,
        publisher,
        classification_no,
        subject,
        publicationDate,
        restrictions,
        image,
        totalCopies,
        borrowedCopies,
        createdAt,
        isActive,
        isReferenceOnly
    ) {
        document.getElementById('updateBookId').value = id;
        document.getElementById('update_Id').value = id;

        // Publication date should always default to today and stay read-only
        const publicationInput = document.getElementById('updatePublicationDate');
        publicationInput.value = new Date().toISOString().split('T')[0];
        publicationInput.readOnly = true;

        document.getElementById('updateTitle').value = title;
        document.getElementById('updateAuthor').value = author;
        document.getElementById('updateISBN').value = isbn;
        document.getElementById('updatePublisher').value = publisher || '';
        document.getElementById('updateClassificationNo').value = classification_no || '';

        const subjectDropdown = document.getElementById('updateSubject');
        for (const option of subjectDropdown.options) {
            if (option.value.toLowerCase() === (subject || '').toLowerCase()) {
                subjectDropdown.value = option.value;
                break;
            }
        }

        document.getElementById('updateRestrictions').value = restrictions || '';

        const currentImageInput = document.getElementById('updateCurrentImage');
        currentImageInput.value = image || '';
        const imageText = document.getElementById('updateImageText');
        const imagePreview = document.getElementById('updateImagePreview');
        if (image) {
            imageText.textContent = image.split('/').pop();
            imageText.style.display = 'block';
            imagePreview.style.display = 'none';
        } else {
            imageText.textContent = 'Click to Change Image';
            imageText.style.display = 'block';
            imagePreview.style.display = 'none';
        }

        document.getElementById('updateBookImage').value = '';

        document.getElementById('updateQuantity').value = totalCopies;
        document.getElementById('updateQuantity').min = borrowedCopies;

        const availableCopies = totalCopies - borrowedCopies;
        document.getElementById('updateAvailableCopies').textContent = availableCopies;
        document.getElementById('updateBorrowedCopies').textContent = borrowedCopies;

        document.getElementById('minCopiesWarning').textContent = `Minimum: ${borrowedCopies} (due to borrowed copies)`;

        if (borrowedCopies > 0) {
            document.getElementById('updateInfoCard').style.display = 'block';
            document.getElementById('updateBorrowWarning').style.display = 'block';
        } else {
            document.getElementById('updateInfoCard').style.display = 'none';
            document.getElementById('updateBorrowWarning').style.display = 'none';
        }

        // Set copy management fields (you'll need to pass these from the server)
        // For now, we'll set default values
        document.getElementById('updateEnableCopyManagement').checked = false;
        document.getElementById('updateCopyPrefix').value = 'SDS';
        document.getElementById('updateNextCopyNumber').value = 1;
        document.getElementById('updateCopyManagementOptions').style.display = 'none';

        // Set the Active/Inactive toggle (handle string 'true'/'false' or boolean)
        const isActiveCheckbox = document.getElementById('updateIsActive');
        const statusText = document.getElementById('updateStatusText');
        isActiveCheckbox.checked = (isActive === true || isActive === 'true');
        statusText.textContent = isActiveCheckbox.checked ? 'Active' : 'Inactive';
        
        // Add event listener for toggle (only once)
        isActiveCheckbox.onchange = function() {
            statusText.textContent = this.checked ? 'Active' : 'Inactive';
        };

        // Set Reference Only toggle
        const refOnly = document.getElementById('updateIsReferenceOnly');
        if (refOnly) refOnly.checked = isReferenceOnly === true || isReferenceOnly === 'true';

        updateAvailablePreview();
        updateCopyPreview();
        document.getElementById('updateBookForm').action = `/Librarian/EditBook/${id}`;
        document.getElementById('updateBookModal').style.display = 'flex';
    }

    function closeUpdateBookModal() {
        document.getElementById('updateBookModal').style.display = 'none';
    }

    function updateAvailablePreview() {
        const totalInput = document.getElementById('updateQuantity');
        const borrowedSpan = document.getElementById('updateBorrowedCopies');
        const preview = document.getElementById('availablePreview');

        if (totalInput && borrowedSpan && totalInput.value) {
            const newTotal = parseInt(totalInput.value);
            const borrowed = parseInt(borrowedSpan.textContent);
            const newAvailable = newTotal - borrowed;

            if (newTotal >= borrowed) {
                preview.innerHTML = `‚ÑπÔ∏è New available copies will be: ${newAvailable}`;
                preview.style.color = '#17a2b8';
            } else {
                preview.innerHTML = `‚ö†Ô∏è Error: Total copies cannot be less than borrowed copies (${borrowed})`;
                preview.style.color = '#dc3545';
            }
        }
    }

    // Delete functionality
    function confirmDelete(bookId, bookTitle, borrowedCopies) {
        if (borrowedCopies > 0) {
            alert('Cannot delete book with active borrows');
            return;
        }
        currentDeleteId = bookId;
        document.getElementById('deleteBookTitle').textContent = bookTitle;
        document.getElementById('confirmDeletePopup').style.display = 'flex';
    }

    function executeDelete() {
        if (currentDeleteId) {
            document.getElementById('deleteBookId').value = currentDeleteId;
            document.getElementById('deleteBookForm').submit();
        }
    }

    function previewImage(input, type) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const fileName = file.name;
            const textId = type === 'add' ? 'addImageText' : 'updateImageText';
            const previewId = type === 'add' ? 'addImagePreview' : 'updateImagePreview';
            document.getElementById(textId).textContent = fileName;
            document.getElementById(textId).style.display = 'block';
            document.getElementById(previewId).style.display = 'none';
         }
    }

    function validateAddForm() {
        console.log('üîç Validating add form...');
        
        const title = document.getElementById('addTitle').value.trim();
        const author = document.getElementById('addAuthor').value.trim();
        const subject = document.getElementById('addSubject').value;
        const quantity = document.getElementById('addQuantity').value;
        
        console.log('Form values:', { title, author, subject, quantity });
        
        if (!title) {
            alert('Title is required');
            return false;
        }
        
        if (!author) {
            alert('Author is required');
            return false;
        }
        
        if (!subject) {
            alert('Subject is required');
            return false;
        }
        
        if (!quantity || parseInt(quantity) < 1) {
            alert('Quantity must be at least 1');
            return false;
        }
        
        console.log('‚úÖ Form validation passed, submitting...');
        return true;
    }

    async function lookupMacForBookL() {
        const type = document.getElementById('macLookupTypeL').value;
        const val = document.getElementById('macLookupValueL').value.trim();
        const resultBox = document.getElementById('macLookupResultL');
        if (!val) {
            alert('Please enter a value');
            return;
        }
        try {
            let url = '';
            if (type === 'isbn') {
                url = `/Librarian/LookupMacBookByIsbn?isbn=${encodeURIComponent(val)}`;
            } else {
                url = `/Librarian/LookupMacBooksByAuthor?authorName=${encodeURIComponent(val)}`;
            }
            const res = await fetch(url);
            const json = await res.json();
            if (!json.success) {
                resultBox.style.display = 'block';
                resultBox.innerHTML = `<div class='lookup-error'>${json.message}</div>`;
                return;
            }
            if (type === 'isbn') {
                const b = json.data;
                document.getElementById('addTitle').value = b.title || '';
                document.getElementById('addAuthor').value = b.author || '';
                document.getElementById('addISBN').value = b.isbn || '';
                document.getElementById('addPublisher').value = b.publisher || '';
                if (b.publication_date) document.getElementById('addPublicationDate').value = (b.publication_date || '').split('T')[0] || '';
                const classificationInput = document.getElementById('addClassificationNo');
                if (classificationInput) classificationInput.value = b.classification_no || '';
                const restrictionsInput = document.getElementById('addRestrictions');
                if (restrictionsInput) restrictionsInput.value = '';
                const subjectDropdown = document.getElementById('addSubject');
                let matched = false;
                for (const option of subjectDropdown.options) {
                    if (option.value.toLowerCase() === (b.subject || '').toLowerCase()) {
                        subjectDropdown.value = option.value;
                        matched = true;
                        break;
                    }
                }
                if (!matched && subjectDropdown.options.length) {
                    const other = Array.from(subjectDropdown.options).find(o => o.value.toLowerCase() === 'other');
                    subjectDropdown.value = other ? other.value : subjectDropdown.options[0].value;
                }
                resultBox.style.display = 'block';
                resultBox.innerHTML = `<div class='lookup-success'>‚úÖ Found: ${b.title} by ${b.author}</div>`;
            } else {
                const books = json.data;
                resultBox.style.display = 'block';
                resultBox.innerHTML = `<div style='max-height:200px; overflow:auto;'>` +
                    books.map(x => `
                        <div style='display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid #eee;'>
                            <div style='flex:1 1 auto;'>${x.title} <small>(${x.isbn})</small></div>
                            <button type='button' class='catalog-add-btn' onclick='selectMacBookL("${x.title?.replace(/"/g, '&quot;')}", "${x.author?.replace(/"/g, '&quot;')}", "${x.isbn}", "${(x.publisher||"").replace(/"/g, '&quot;')}", "${(x.subject||"").replace(/"/g, '&quot;')}", "${x.publication_date||""}")'>Use</button>
                        </div>
                    `).join('') +
                    `</div>`;
            }
        } catch (e) {
            resultBox.style.display = 'block';
            resultBox.innerHTML = `<div class='lookup-error'>Error: ${e.message}</div>`;
        }
    }

    function selectMacBookL(title, author, isbn, publisher, subject, publicationDate) {
        document.getElementById('addTitle').value = title || '';
        document.getElementById('addAuthor').value = author || '';
        document.getElementById('addISBN').value = isbn || '';
        document.getElementById('addPublisher').value = publisher || '';
        if (publicationDate) document.getElementById('addPublicationDate').value = (publicationDate || '').split('T')[0] || '';
        const classificationInput = document.getElementById('addClassificationNo');
        if (classificationInput) classificationInput.value = '';
        const restrictionsInput = document.getElementById('addRestrictions');
        if (restrictionsInput) restrictionsInput.value = '';
        const subjectDropdown = document.getElementById('addSubject');
        let matched = false;
        for (const option of subjectDropdown.options) {
            if (option.value.toLowerCase() === (subject || '').toLowerCase()) {
                subjectDropdown.value = option.value;
                matched = true;
                break;
            }
        }
        if (!matched && subjectDropdown.options.length) {
            const other = Array.from(subjectDropdown.options).find(o => o.value.toLowerCase() === 'other');
            subjectDropdown.value = other ? other.value : subjectDropdown.options[0].value;
        }
        document.getElementById('macLookupResultL').style.display = 'none';
    }

    // Copy Management Functions for Add Modal
    function toggleAddCopyManagement() {
        const checkbox = document.getElementById('addEnableCopyManagement');
        const options = document.getElementById('addCopyManagementOptions');
        
        if (checkbox.checked) {
            options.style.display = 'block';
            updateAddCopyPreview();
        } else {
            options.style.display = 'none';
        }
    }

    function updateAddCopyPreview() {
        const quantity = parseInt(document.getElementById('addQuantity').value) || 1;
        const prefix = document.getElementById('addCopyPrefix').value || 'SDS';
        const startNumber = parseInt(document.getElementById('addNextCopyNumber').value) || 1;
        const preview = document.getElementById('addCopyIdPreview');
        
        let previewHtml = '';
        for (let i = 0; i < Math.min(quantity, 10); i++) {
            const copyNumber = startNumber + i;
            const copyId = `${prefix}-${copyNumber.toString().padStart(4, '0')}`;
            previewHtml += `<span class="copy-id-preview">${copyId}</span>`;
        }
        
        if (quantity > 10) {
            previewHtml += `<span class="copy-id-preview">... and ${quantity - 10} more</span>`;
        }
        
        preview.innerHTML = previewHtml;
    }

    // Copy Management Functions for Update Modal
    function toggleUpdateCopyManagement() {
        const checkbox = document.getElementById('updateEnableCopyManagement');
        const options = document.getElementById('updateCopyManagementOptions');
        
        if (checkbox.checked) {
            options.style.display = 'block';
            updateCopyPreview();
        } else {
            options.style.display = 'none';
        }
    }

    function updateCopyPreview() {
        const quantity = parseInt(document.getElementById('updateQuantity').value) || 1;
        const prefix = document.getElementById('updateCopyPrefix').value || 'SDS';
        const startNumber = parseInt(document.getElementById('updateNextCopyNumber').value) || 1;
        const preview = document.getElementById('updateCopyIdPreview');
        
        let previewHtml = '';
        for (let i = 0; i < Math.min(quantity, 10); i++) {
            const copyNumber = startNumber + i;
            const copyId = `${prefix}-${copyNumber.toString().padStart(4, '0')}`;
            previewHtml += `<span class="copy-id-preview">${copyId}</span>`;
        }
        
        if (quantity > 10) {
            previewHtml += `<span class="copy-id-preview">... and ${quantity - 10} more</span>`;
        }
        
        preview.innerHTML = previewHtml;
    }

    function validateUpdateForm() {
        const totalCopies = parseInt(document.getElementById('updateQuantity').value);
        const borrowedCopies = parseInt(document.getElementById('updateBorrowedCopies').textContent);
        if (totalCopies < borrowedCopies) {
            alert(`Total copies cannot be less than borrowed copies (${borrowedCopies})`);
            return false;
        }
        return true;
    }

    function closePopup(popupId) {
        document.getElementById(popupId).style.display = 'none';
        if (popupId === 'bookSavedPopup' || popupId === 'bookUpdatedPopup' || popupId === 'bookDeletedPopup') {
            location.reload();
        }
    }

    window.onclick = function(event) {
        const addModal = document.getElementById('addBookModal');
        const updateModal = document.getElementById('updateBookModal');
        if (event.target == addModal) closeAddBookModal();
        if (event.target == updateModal) closeUpdateBookModal();
    }

    setTimeout(function() {
        document.querySelectorAll('.alert').forEach(function(alert) {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        });
    }, 5000);

    // Copy Details Modal Functions
    async function showCopyDetails(bookId) {
        try {
            const response = await fetch(`/Librarian/GetBookCopies?bookId=${bookId}`);
            const result = await response.json();
            
            if (result.success) {
                const data = result.data;
                
                // Update modal header info
                document.getElementById('copyBookTitle').textContent = data.bookTitle;
                document.getElementById('copyBookAuthor').textContent = data.bookAuthor;
                document.getElementById('copyBookIsbn').textContent = data.bookIsbn;
                document.getElementById('copyTotalCopies').textContent = data.totalCopies;
                
                // Populate copy details table
                const tbody = document.getElementById('copyDetailsTableBody');
                tbody.innerHTML = '';
                
                data.copies.forEach(copy => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${copy.copyId}</td>
                        <td>${copy.barcode}</td>
                        <td><span class="copy-status copy-status-${copy.status.toLowerCase().replace(' ', '-')}">${copy.status}</span></td>
                        <td><span class="copy-condition copy-condition-${copy.condition.toLowerCase().replace(' ', '-')}">${copy.condition}</span></td>
                        <td>${copy.location}</td>
                        <td>${copy.borrowCount}</td>
                        <td>${copy.lastBorrowedDate}</td>
                        <td>
                            <div class="copy-actions">
                                <select onchange="updateCopyStatus('${copy.id}', this.value)" class="copy-status-select">
                                    <option value="">Change Status</option>
                                    <option value="status:0" ${copy.isAvailable ? 'selected' : ''}>Available</option>
                                    <option value="status:1" ${copy.isBorrowed ? 'selected' : ''}>Borrowed</option>
                                    <option value="status:2" ${copy.isLost ? 'selected' : ''}>Lost</option>
                                    <option value="status:3" ${copy.isDamaged ? 'selected' : ''}>Damaged</option>
                                    <option value="status:4">Maintenance</option>
                                    <option value="status:5">Retired</option>
                                </select>
                                <button onclick="showCopyNotes('${copy.id}', '${copy.copyId}', '${copy.notes}')" class="copy-notes-btn" title="Add Notes">
                                    <i class="fas fa-sticky-note"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Show modal
                document.getElementById('copyDetailsModal').style.display = 'flex';
            } else {
                alert('Error loading copy details: ' + result.message);
            }
        } catch (error) {
            console.error('Error loading copy details:', error);
            alert('Error loading copy details: ' + error.message);
        }
    }

    function closeCopyDetailsModal() {
        document.getElementById('copyDetailsModal').style.display = 'none';
    }

    async function updateCopyStatus(copyId, actionValue) {
        if (!actionValue) return;
        
        const [action, value] = actionValue.split(':');
        
        try {
            const request = {
                CopyId: copyId,
                Action: action,
                Status: parseInt(value),
                Condition: 1, // Good
                Notes: ""
            };
            
            const response = await fetch('/Librarian/UpdateCopyStatus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(request)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Refresh the copy details
                const bookId = document.querySelector('[onclick*="showCopyDetails"]').onclick.toString().match(/'([^']+)'/)[1];
                showCopyDetails(bookId);
            } else {
                alert('Error updating copy status: ' + result.message);
            }
        } catch (error) {
            console.error('Error updating copy status:', error);
            alert('Error updating copy status: ' + error.message);
        }
    }

    function showCopyNotes(copyId, copyIdDisplay, currentNotes) {
        const notes = prompt(`Add notes for copy ${copyIdDisplay}:`, currentNotes || '');
        if (notes !== null) {
            // Here you could add functionality to update copy notes
            console.log(`Updating notes for copy ${copyId}: ${notes}`);
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const addModal = document.getElementById('addBookModal');
        const updateModal = document.getElementById('updateBookModal');
        const copyModal = document.getElementById('copyDetailsModal');
        
        if (event.target == addModal) closeAddBookModal();
        if (event.target == updateModal) closeUpdateBookModal();
        if (event.target == copyModal) closeCopyDetailsModal();
    }

    // ‚úÖ FIXED: Show success popups AFTER DOM is ready
    document.addEventListener("DOMContentLoaded", function() {
        // Add form submit listener for debugging
        const addForm = document.getElementById('addBookForm');
        if (addForm) {
            addForm.addEventListener('submit', function(e) {
                console.log('üöÄ Add book form submitted!');
                console.log('Form data:', new FormData(addForm));
            });
        }
        
        // Add click listener to submit button
        const submitBtn = document.getElementById('addBookSubmitBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                console.log('üñ±Ô∏è Submit button clicked!');
            });
        }
        
    @if (TempData["BookAdded"] != null)
    {
        <text>document.getElementById('bookSavedPopup').style.display = 'flex';</text>
    }
    @if (TempData["BookUpdated"] != null)
    {
        <text>document.getElementById('bookUpdatedPopup').style.display = 'flex';</text>
    }
    @if (TempData["BookDeleted"] != null)
    {
        <text>document.getElementById('bookDeletedPopup').style.display = 'flex';</text>
    }
    });
</script>

<style>
    /* Alert styles */
    .alert {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        position: relative;
        transition: opacity 0.3s ease;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .btn-close {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        opacity: 0.5;
    }

    .btn-close:hover {
        opacity: 1;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #999;
    }

    /* Filter panel */
    .filter-panel {
        margin: 1rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .filter-panel select {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        max-width: 300px;
    }

    /* Disabled button */
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Availability Container */
    .availability-container {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    /* Copy Details Button */
    .copy-details-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: background-color 0.2s;
    }

    .copy-details-btn:hover {
        background: #0056b3;
    }

    /* Copy Details Modal */
    .copy-details-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .copy-details-content {
        background-color: white;
        border-radius: 8px;
        width: 90%;
        max-width: 1200px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .copy-details-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .copy-details-header h3 {
        margin: 0;
        color: #333;
    }

    .copy-details-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
    }

    .copy-details-close:hover {
        color: #000;
    }

    .copy-details-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .copy-details-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .copy-details-info p {
        margin: 5px 0;
        color: #555;
    }

    .copy-details-table-wrapper {
        overflow-x: auto;
    }

    .copy-details-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .copy-details-table th,
    .copy-details-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .copy-details-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
    }

    .copy-details-table tr:hover {
        background-color: #f5f5f5;
    }

    /* Copy Status Styles */
    .copy-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .copy-status-available {
        background-color: #d4edda;
        color: #155724;
    }

    .copy-status-borrowed {
        background-color: #cce5ff;
        color: #004085;
    }

    .copy-status-lost {
        background-color: #f8d7da;
        color: #721c24;
    }

    .copy-status-damaged {
        background-color: #fff3cd;
        color: #856404;
    }

    .copy-status-maintenance {
        background-color: #e2e3e5;
        color: #383d41;
    }

    .copy-status-retired {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    /* Copy Condition Styles */
    .copy-condition {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
    }

    .copy-condition-excellent {
        background-color: #d4edda;
        color: #155724;
    }

    .copy-condition-good {
        background-color: #cce5ff;
        color: #004085;
    }

    .copy-condition-fair {
        background-color: #fff3cd;
        color: #856404;
    }

    .copy-condition-poor {
        background-color: #f8d7da;
        color: #721c24;
    }

    .copy-condition-damaged {
        background-color: #f5c6cb;
        color: #721c24;
    }

    /* Copy Actions */
    .copy-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .copy-status-select {
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 12px;
    }

    .copy-notes-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .copy-notes-btn:hover {
        background: #545b62;
    }

    /* Copy Management Section */
    .copy-management-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
    }

    .copy-management-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .copy-management-header h4 {
        margin: 0;
        color: #333;
    }

    .copy-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        cursor: pointer;
    }

    .copy-toggle input[type="checkbox"] {
        transform: scale(1.2);
    }

    .copy-preview {
        margin-top: 15px;
        padding: 10px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    .copy-id-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }

    .copy-id-preview {
        background: #e9ecef;
        padding: 4px 8px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        color: #495057;
    }
</style>

