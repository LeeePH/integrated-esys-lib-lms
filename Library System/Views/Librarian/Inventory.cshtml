@model SystemLibrary.ViewModels.InventoryReportViewModel
@{
    ViewBag.Title = "Inventory Status";
    ViewBag.ActiveTab = "inventory";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/inventorystats.css" />

<style>
    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .export-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.3s ease;
    }

    .export-btn:hover {
        background-color: #3367d6;
    }

    .export-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .export-btn svg {
        width: 16px;
        height: 16px;
    }

    .detailed-data-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        color: #333;
    }
</style>

<main class="content">
    <header>
        <h1>Reports and Analytics</h1>
        <div class="filter">
            <select id="reportFilter" onchange="filterByDateRange(this.value)">
                <option value="30" selected="@(Model.DaysRange == 30)">Last 30 Days</option>
                <option value="60" selected="@(Model.DaysRange == 60)">Last 60 Days</option>
                <option value="90" selected="@(Model.DaysRange == 90)">Last 90 Days</option>
            </select>
        </div>
    </header>

    <section class="tabs">
        @await Html.PartialAsync("_ReportTabs")
    </section>

    <section class="report-card">
        <div class="report-header">
            <h2>Inventory Status</h2>
            <button id="exportMainInventoryBtn" class="export-btn" onclick="exportMainInventoryToPDF()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export as PDF
            </button>
        </div>

        <!-- Summary Stats -->
        <div class="stats">
            <div class="stat blue clickable-stat" data-type="totalbooks">
                <h3>@Model.TotalBooks</h3>
                <p>Total Books</p>
            </div>
            <div class="stat green clickable-stat" data-type="totalavailable">
                <h3>@Model.TotalAvailable</h3>
                <p>Available</p>
            </div>
            <div class="stat yellow clickable-stat" data-type="totalborrowed">
                <h3>@Model.TotalBorrowed</h3>
                <p>Borrowed</p>
            </div>
            <div class="stat red clickable-stat" data-type="totalreserved">
                <h3>@Model.TotalReserved</h3>
                <p>Reserved</p>
            </div>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
            @if (Model.Categories.Any())
            {
                    <table id="inventoryCategoryTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Total Books</th>
                                <th>Available</th>
                                <th>Borrowed</th>
                                <th>Reserved</th>
                                <th>Utilization</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var cat in Model.Categories)
                        {
                                    <tr>
                                        <td>@cat.Category</td>
                                        <td>@cat.TotalBooks</td>
                                        <td>@cat.Available</td>
                                        <td>@cat.Borrowed</td>
                                        <td>@cat.Reserved</td>
                                        <td>
                                            <div class="progress-bar">
                                                <div class="progress" style="width:@cat.Utilization%;"></div>
                                                <span>@cat.Utilization%</span>
                                            </div>
                                        </td>
                                    </tr>
                        }
                        </tbody>
                    </table>
            }
            else
            {
                    <div class="empty-state">
                        <p>No inventory data available</p>
                    </div>
            }
        </div>

        <!-- Detailed Data Section -->
        <div id="detailedDataSection" class="detailed-data-section" style="display: none;">
            <div class="detailed-data-header">
                <h3 id="detailedDataTitle">Detailed Data</h3>
                <div class="header-actions">
                    <button id="exportDetailedInventoryBtn" class="export-btn" onclick="exportDetailedInventoryToPDF()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export as PDF
                    </button>
                    <button id="closeDetailedData" class="close-btn">&times;</button>
                </div>
            </div>
            <div class="detailed-data-content">
                <div id="detailedDataTable" class="table-responsive">
                    <!-- Data will be populated here -->
                </div>
            </div>
        </div>
    </section>
</main>

@section Scripts {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
        <script>
            // Global variables to store current detailed data
            let currentDetailedType = '';
            let currentDetailedItems = [];
            let currentDetailedTitle = '';

            function filterByDateRange(days) {
                window.location.href = '@Url.Action("Inventory", "Librarian")?daysRange=' + days;
            }

            document.addEventListener("DOMContentLoaded", () => {
                const activeTab = document.querySelector('[data-tab="inventory"]');
                if (activeTab) activeTab.classList.add("active");

                // Handle stat card clicks
                const statCards = document.querySelectorAll('.clickable-stat');
                const detailedDataSection = document.getElementById('detailedDataSection');
                const detailedDataTitle = document.getElementById('detailedDataTitle');
                const detailedDataTable = document.getElementById('detailedDataTable');
                const closeDetailedData = document.getElementById('closeDetailedData');

                statCards.forEach(card => {
                    card.addEventListener('click', function() {
                        const dataType = this.getAttribute('data-type');
                        loadDetailedData(dataType);
                    });
                });

                closeDetailedData.addEventListener('click', function() {
                    detailedDataSection.style.display = 'none';
                });

                async function loadDetailedData(type) {
                    try {
                        const response = await fetch(`@Url.Action("GetDetailedInventoryData", "Librarian")?type=${type}&daysRange=@Model.DaysRange`);
                        const result = await response.json();

                        if (result.success) {
                            currentDetailedType = type;
                            currentDetailedItems = result.data.data;
                            currentDetailedTitle = result.data.type;
                            displayDetailedData(result.data, type);
                        } else {
                            alert('Error loading detailed data: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error loading detailed data');
                    }
                }

                function displayDetailedData(data, type) {
                    const title = data.type;
                    const items = data.data;

                    // Show detailed data section below the table
                    detailedDataTitle.textContent = title;
                    detailedDataTable.innerHTML = createTable(items, type);
                    detailedDataSection.style.display = 'block';

                    // Scroll to the detailed data section
                    detailedDataSection.scrollIntoView({ behavior: 'smooth' });
                }

                function createTable(items, type) {
                    if (!items || items.length === 0) {
                        return '<p>No data available for the selected period.</p>';
                    }

                    let table = '<table class="table table-striped table-hover">';

                    // Create header based on type
                    if (type === 'totalbooks') {
                        table += '<thead><tr><th>Title</th><th>Author</th><th>Subject</th><th>ISBN</th><th>Total Copies</th><th>Available</th><th>Borrowed</th><th>Publisher</th><th>Publication Date</th><th>Classification No</th></tr></thead>';
                    } else if (type === 'totalavailable') {
                        table += '<thead><tr><th>Title</th><th>Author</th><th>Subject</th><th>ISBN</th><th>Available Copies</th><th>Total Copies</th><th>Publisher</th><th>Publication Date</th><th>Classification No</th></tr></thead>';
                    } else if (type === 'totalborrowed') {
                        table += '<thead><tr><th>Title</th><th>Author</th><th>Subject</th><th>ISBN</th><th>Borrowed Copies</th><th>Total Copies</th><th>Available</th><th>Publisher</th><th>Publication Date</th><th>Classification No</th></tr></thead>';
                    } else if (type === 'totalreserved') {
                        table += '<thead><tr><th>Student Name</th><th>Student Number</th><th>Book Title</th><th>Author</th><th>Subject</th><th>ISBN</th><th>Reservation Date</th><th>Status</th><th>Copy ID</th></tr></thead>';
                    }

                    table += '<tbody>';

                    items.forEach(item => {
                        table += '<tr>';
                        if (type === 'totalbooks') {
                            table += `<td>${item.title || 'N/A'}</td>`;
                            table += `<td>${item.author || 'N/A'}</td>`;
                            table += `<td>${item.subject || 'N/A'}</td>`;
                            table += `<td>${item.isbn || 'N/A'}</td>`;
                            table += `<td><span class="badge badge-info">${item.totalCopies || 0}</span></td>`;
                            table += `<td><span class="badge badge-success">${item.availableCopies || 0}</span></td>`;
                            table += `<td><span class="badge badge-warning">${item.borrowedCopies || 0}</span></td>`;
                            table += `<td>${item.publisher || 'N/A'}</td>`;
                            table += `<td>${item.publicationDate || 'N/A'}</td>`;
                            table += `<td>${item.classificationNo || 'N/A'}</td>`;
                        } else if (type === 'totalavailable') {
                            table += `<td>${item.title || 'N/A'}</td>`;
                            table += `<td>${item.author || 'N/A'}</td>`;
                            table += `<td>${item.subject || 'N/A'}</td>`;
                            table += `<td>${item.isbn || 'N/A'}</td>`;
                            table += `<td><span class="badge badge-success">${item.availableCopies || 0}</span></td>`;
                            table += `<td><span class="badge badge-info">${item.totalCopies || 0}</span></td>`;
                            table += `<td>${item.publisher || 'N/A'}</td>`;
                            table += `<td>${item.publicationDate || 'N/A'}</td>`;
                            table += `<td>${item.classificationNo || 'N/A'}</td>`;
                        } else if (type === 'totalborrowed') {
                            table += `<td>${item.title || 'N/A'}</td>`;
                            table += `<td>${item.author || 'N/A'}</td>`;
                            table += `<td>${item.subject || 'N/A'}</td>`;
                            table += `<td>${item.isbn || 'N/A'}</td>`;
                            table += `<td><span class="badge badge-warning">${item.borrowedCopies || 0}</span></td>`;
                            table += `<td><span class="badge badge-info">${item.totalCopies || 0}</span></td>`;
                            table += `<td><span class="badge badge-success">${item.availableCopies || 0}</span></td>`;
                            table += `<td>${item.publisher || 'N/A'}</td>`;
                            table += `<td>${item.publicationDate || 'N/A'}</td>`;
                            table += `<td>${item.classificationNo || 'N/A'}</td>`;
                        } else if (type === 'totalreserved') {
                            table += `<td>${item.studentName || 'N/A'}</td>`;
                            table += `<td>${item.studentNumber || 'N/A'}</td>`;
                            table += `<td>${item.bookTitle || 'N/A'}</td>`;
                            table += `<td>${item.bookAuthor || 'N/A'}</td>`;
                            table += `<td>${item.subject || 'N/A'}</td>`;
                            table += `<td>${item.isbn || 'N/A'}</td>`;
                            table += `<td>${item.reservationDate || 'N/A'}</td>`;
                            table += `<td><span class="badge badge-info">${item.status || 'N/A'}</span></td>`;
                            table += `<td>${item.copyIdentifier || 'N/A'}</td>`;
                        }
                        table += '</tr>';
                    });

                    table += '</tbody></table>';
                    return table;
                }
            });

            // PDF Export Functions
            function exportMainInventoryToPDF() {
                const exportBtn = document.getElementById('exportMainInventoryBtn');
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<span>Generating PDF...</span>';

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');

                    // Get table data
                    const table = document.getElementById('inventoryCategoryTable');
                    if (!table) {
                        alert('No data available to export');
                        return;
                    }

                    // Add title
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Inventory Status Report', 14, 15);

                    // Add metadata
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const dateRange = document.getElementById('reportFilter').selectedOptions[0].text;
                    const generatedDate = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    doc.text(`Date Range: ${dateRange}`, 14, 22);
                    doc.text(`Generated: ${generatedDate}`, 14, 27);

                    // Summary statistics
                    doc.text(`Total Books: @Model.TotalBooks`, 14, 34);
                    doc.text(`Available: @Model.TotalAvailable`, 70, 34);
                    doc.text(`Borrowed: @Model.TotalBorrowed`, 120, 34);
                    doc.text(`Reserved: @Model.TotalReserved`, 170, 34);

                    // Prepare table data from DOM
                    const rows = Array.from(table.querySelectorAll('tbody tr'));
                    const tableData = rows.map(row => {
                        const cells = row.querySelectorAll('td');
                        return [
                            cells[0]?.textContent || 'N/A',
                            cells[1]?.textContent || '0',
                            cells[2]?.textContent || '0',
                            cells[3]?.textContent || '0',
                            cells[4]?.textContent || '0',
                            cells[5]?.querySelector('span')?.textContent || '0%'
                        ];
                    });

                    // Add table
                    doc.autoTable({
                        head: [['Category', 'Total Books', 'Available', 'Borrowed', 'Reserved', 'Utilization']],
                        body: tableData,
                        startY: 40,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [66, 133, 244],
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        columnStyles: {
                            0: { cellWidth: 80 },
                            1: { cellWidth: 30, halign: 'center' },
                            2: { cellWidth: 30, halign: 'center' },
                            3: { cellWidth: 30, halign: 'center' },
                            4: { cellWidth: 30, halign: 'center' },
                            5: { cellWidth: 30, halign: 'center' }
                        }
                    });

                    // Add footer with page numbers
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'italic');
                        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                    }

                    // Save the PDF
                    const fileName = `Inventory_Status_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export as PDF
                    `;
                }
            }

            function exportDetailedInventoryToPDF() {
                if (!currentDetailedItems || currentDetailedItems.length === 0) {
                    alert('No data available to export');
                    return;
                }

                const exportBtn = document.getElementById('exportDetailedInventoryBtn');
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<span>Generating PDF...</span>';

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');

                    // Add title
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text(currentDetailedTitle, 14, 15);

                    // Add metadata
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const dateRange = document.getElementById('reportFilter').selectedOptions[0].text;
                    const generatedDate = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    doc.text(`Date Range: ${dateRange}`, 14, 22);
                    doc.text(`Generated: ${generatedDate}`, 14, 27);
                    doc.text(`Total Records: ${currentDetailedItems.length}`, 14, 32);

                    // Prepare table data based on type
                    let headers = [];
                    let rows = [];
                    let columnStyles = {};

                    if (currentDetailedType === 'totalbooks') {
                        headers = [['Title', 'Author', 'Subject', 'ISBN', 'Total', 'Available', 'Borrowed', 'Publisher', 'Pub. Date', 'Class. No']];
                        rows = currentDetailedItems.map(item => [
                            item.title || 'N/A',
                            item.author || 'N/A',
                            item.subject || 'N/A',
                            item.isbn || 'N/A',
                            item.totalCopies || 0,
                            item.availableCopies || 0,
                            item.borrowedCopies || 0,
                            item.publisher || 'N/A',
                            item.publicationDate || 'N/A',
                            item.classificationNo || 'N/A'
                        ]);
                        columnStyles = {
                            0: { cellWidth: 40 },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 25 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 15, halign: 'center' },
                            5: { cellWidth: 18, halign: 'center' },
                            6: { cellWidth: 18, halign: 'center' },
                            7: { cellWidth: 30 },
                            8: { cellWidth: 20 },
                            9: { cellWidth: 20 }
                        };
                    } else if (currentDetailedType === 'totalavailable') {
                        headers = [['Title', 'Author', 'Subject', 'ISBN', 'Available', 'Total', 'Publisher', 'Pub. Date', 'Class. No']];
                        rows = currentDetailedItems.map(item => [
                            item.title || 'N/A',
                            item.author || 'N/A',
                            item.subject || 'N/A',
                            item.isbn || 'N/A',
                            item.availableCopies || 0,
                            item.totalCopies || 0,
                            item.publisher || 'N/A',
                            item.publicationDate || 'N/A',
                            item.classificationNo || 'N/A'
                        ]);
                        columnStyles = {
                            0: { cellWidth: 45 },
                            1: { cellWidth: 35 },
                            2: { cellWidth: 30 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 20, halign: 'center' },
                            5: { cellWidth: 18, halign: 'center' },
                            6: { cellWidth: 35 },
                            7: { cellWidth: 25 },
                            8: { cellWidth: 25 }
                        };
                    } else if (currentDetailedType === 'totalborrowed') {
                        headers = [['Title', 'Author', 'Subject', 'ISBN', 'Borrowed', 'Total', 'Available', 'Publisher', 'Pub. Date', 'Class. No']];
                        rows = currentDetailedItems.map(item => [
                            item.title || 'N/A',
                            item.author || 'N/A',
                            item.subject || 'N/A',
                            item.isbn || 'N/A',
                            item.borrowedCopies || 0,
                            item.totalCopies || 0,
                            item.availableCopies || 0,
                            item.publisher || 'N/A',
                            item.publicationDate || 'N/A',
                            item.classificationNo || 'N/A'
                        ]);
                        columnStyles = {
                            0: { cellWidth: 40 },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 25 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 18, halign: 'center' },
                            5: { cellWidth: 15, halign: 'center' },
                            6: { cellWidth: 18, halign: 'center' },
                            7: { cellWidth: 30 },
                            8: { cellWidth: 20 },
                            9: { cellWidth: 20 }
                        };
                    } else if (currentDetailedType === 'totalreserved') {
                        headers = [['Student Name', 'Student No.', 'Book Title', 'Author', 'Subject', 'ISBN', 'Reservation Date', 'Status', 'Copy ID']];
                        rows = currentDetailedItems.map(item => [
                            item.studentName || 'N/A',
                            item.studentNumber || 'N/A',
                            item.bookTitle || 'N/A',
                            item.bookAuthor || 'N/A',
                            item.subject || 'N/A',
                            item.isbn || 'N/A',
                            item.reservationDate || 'N/A',
                            item.status || 'N/A',
                            item.copyIdentifier || 'N/A'
                        ]);
                        columnStyles = {
                            0: { cellWidth: 35 },
                            1: { cellWidth: 25 },
                            2: { cellWidth: 40 },
                            3: { cellWidth: 30 },
                            4: { cellWidth: 25 },
                            5: { cellWidth: 25 },
                            6: { cellWidth: 30 },
                            7: { cellWidth: 20 },
                            8: { cellWidth: 20 }
                        };
                    }

                    // Add table
                    doc.autoTable({
                        head: headers,
                        body: rows,
                        startY: 38,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [66, 133, 244],
                            textColor: 255,
                            fontStyle: 'bold',
                            fontSize: 8
                        },
                        bodyStyles: {
                            fontSize: 7
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        columnStyles: columnStyles,
                        styles: {
                            cellPadding: 2,
                            overflow: 'linebreak'
                        }
                    });

                    // Add footer with page numbers
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'italic');
                        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width - 30, doc.internal.pageSize.height - 10);
                    }

                    // Save the PDF
                    const sanitizedTitle = currentDetailedTitle.replace(/[^a-z0-9]/gi, '_');
                    const fileName = `${sanitizedTitle}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(fileName);

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export as PDF
                    `;
                }
            }
        </script>
}