@model SystemLibrary.ViewModels.LoginViewModel
@{
    ViewBag.Title = "Login";
    Layout = null; 
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewBag.Title</title>
    <link rel="stylesheet" href="~/css/login.css" />

    <style>
        /* Added error modal styles */
        .error-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .error-modal-overlay.active {
            display: flex;
        }

        .error-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .error-modal-content {
            padding: 40px 30px;
            text-align: center;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 25px;
        }

        .error-modal h2 {
            color: #dc3545;
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 15px 0;
        }

        .error-modal p {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            margin: 0 0 30px 0;
        }

        .error-modal-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 14px 50px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .error-modal-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="login-wrapper">
        <div class="overlay"></div>

        <div class="login-box">
            <div class="text-center">
                <h1 class="login-title">Log In</h1>
                <div class="underline"></div>
            </div>

            @using (Html.BeginForm("Login", "Account", FormMethod.Post, new { id = "loginForm" }))
            {
                            <div class="form-group">
                                <label for="Email">Email</label>
                    @Html.TextBoxFor(m => m.Email, new { @class = "input-field", placeholder = "Enter Email..." })
                            </div>

                            <div class="form-group">
                                <label for="Password">Password</label>
                    @Html.PasswordFor(m => m.Password, new { @class = "input-field", placeholder = "Enter Password..." })
                            </div>

                            <button type="submit" class="login-btn">SIGN IN</button>
            }
        </div>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div id="login-error-data"
             data-error-message="@TempData["ErrorMessage"]"
             data-lockout-seconds="@TempData["LockoutSeconds"]">
        </div>
    }

    <!-- Added error modal for wrong username -->
    <div id="errorModal" class="error-modal-overlay">
        <div class="error-modal">
            <div class="error-modal-content">
                <svg class="error-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#dc3545" stroke-width="4"/>
                    <line x1="30" y1="30" x2="70" y2="70" stroke="#dc3545" stroke-width="4" stroke-linecap="round"/>
                    <line x1="70" y1="30" x2="30" y2="70" stroke="#dc3545" stroke-width="4" stroke-linecap="round"/>
                </svg>
                <h2 id="errorTitle">Login Failed</h2>
                <p id="errorMessage">Invalid username or password. Please try again.</p>
                <button type="button" class="error-modal-button" onclick="closeErrorModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("loginForm").addEventListener("submit", function (e) {
            var email = document.querySelector('input[name="Email"]').value.trim();
            var password = document.querySelector('input[name="Password"]').value.trim();

            if (email !== "" && password === "") {
                e.preventDefault(); // stop form from submitting
                showCustomPasswordError();
            }
        });

        function showCustomPasswordError() {
            document.getElementById('errorTitle').textContent = "Password Required";
            document.getElementById('errorMessage').textContent =
                "Please input your password before signing in.";

            document.getElementById('errorModal').classList.add('active');
        }
            function closeErrorModal() {
                document.getElementById('errorModal').classList.remove('active');
            }

            document.getElementById('errorModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeErrorModal();
                }
            });

        window.addEventListener('DOMContentLoaded', function() {
            var dataEl = document.getElementById('login-error-data');
            if (!dataEl) return;

            var errorMessage = (dataEl.getAttribute('data-error-message') || '').toString();
            if (!errorMessage) return;

            var errorTitle = 'Login Failed';
            var lockoutSeconds = parseInt(dataEl.getAttribute('data-lockout-seconds') || '0', 10);

            if (errorMessage === 'LOCKED') {
                errorTitle = 'Account Locked';
                var secondsRemaining = isNaN(lockoutSeconds) ? 0 : lockoutSeconds;

                function renderLockoutMessage() {
                    var mins = Math.floor(secondsRemaining / 60);
                    var secs = secondsRemaining % 60;
                    var parts = [];
                    if (mins > 0) {
                        parts.push(mins + ' minute' + (mins > 1 ? 's' : ''));
                    }
                    parts.push(secs + ' second' + (secs !== 1 ? 's' : ''));
                    var timeStr = parts.join(' ');

                    document.getElementById('errorMessage').textContent =
                        'Too many failed attempts. Your account is locked for ' + timeStr + '.';
                }

                renderLockoutMessage();

                if (secondsRemaining > 0) {
                    var intervalId = setInterval(function () {
                        secondsRemaining--;
                        if (secondsRemaining <= 0) {
                            clearInterval(intervalId);
                            document.getElementById('errorMessage').textContent =
                                'Lock period has ended. Please try logging in again.';
                            return;
                        }
                        renderLockoutMessage();
                    }, 1000);
                }
            } else {
                var lower = errorMessage.toLowerCase();

                if (lower.includes('email')) {
                    errorTitle = 'Invalid Email or Password';
                    errorMessage = 'The email or password you entered does not exist. Please check and try again.';
                } else if (lower.includes('password') && lower.includes('attempt')) {
                    errorTitle = 'Incorrect Username or Password';
                    // keep the original remaining attempts message
                } else if (lower.includes('password')) {
                    errorTitle = 'Incorrect Username or Password';
                    errorMessage = 'The username or password you entered is incorrect. Please try again.';
                } else if (lower.includes('locked')) {
                    errorTitle = 'Account Locked';
                }

                document.getElementById('errorMessage').textContent = errorMessage;
            }

            document.getElementById('errorTitle').textContent = errorTitle;
            document.getElementById('errorModal').classList.add('active');
        });
    </script>
</body>
</html>