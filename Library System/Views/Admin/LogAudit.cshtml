@model List<SystemLibrary.Models.AuditLog>
@{
    ViewBag.Title = "System Maintenance - Log Audit";
    Layout = "_Layout";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>System Maintenance - Log Audits</title>
    <link rel="stylesheet" href="~/css/Admin/LogAudit.css" />
    <style>
        .filter-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            padding: 32px;
            margin-bottom: 28px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .filter-section:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #0f5a7f;
        }

        .filter-section h3 {
            margin: 0 0 24px 0;
            font-size: 20px;
            font-weight: 700;
            color: #0f5a7f;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
            align-items: end;
        }

        .filter-row:last-of-type {
            grid-template-columns: 1fr 1fr 1fr;
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 14px;
            color: #374151;
            margin-bottom: 0;
            letter-spacing: 0.025em;
        }

        .filter-group input, .filter-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            background: #ffffff;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #0f5a7f;
            box-shadow: 0 0 0 3px rgba(15, 90, 127, 0.1);
            transform: translateY(-1px);
        }

        .filter-group input:hover, .filter-group select:hover {
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .filter-buttons {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f5a7f 0%, #1a7ba8 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0a3d54 0%, #0f5a7f 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        /* Responsive Design for Filter Section */
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .filter-row:last-of-type {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .btn {
                width: 100%;
                min-width: auto;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .log-entry {
            border-left: 4px solid #dee2e6;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 0 6px 6px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .log-entry.book-management { border-left-color: #2196F3; }
        .log-entry.user-management { border-left-color: #4CAF50; }
        .log-entry.borrowing { border-left-color: #FF9800; }
        .log-entry.penalty { border-left-color: #FF5722; }
        .log-entry.system { border-left-color: #9C27B0; }
        .log-entry.security { border-left-color: #F44336; }
        .log-entry.report { border-left-color: #00BCD4; }

        .log-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-icon {
            font-size: 20px;
            margin-right: 10px;
        }

        .log-action {
            font-weight: 600;
            color: #495057;
            flex: 1;
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 14px;
        }

        .log-user {
            color: #007bff;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .log-details {
            color: #6c757d;
            line-height: 1.5;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination button:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .no-logs {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-logs-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <main class="content">
        <!-- Header -->
        <header>
            <h1>System Maintenance</h1>
        </header>

        <!-- Tabs below the header -->
        <div class="tabs">
            <button onclick="location.href='@Url.Action("SystemMaintenance", "Admin")'">Database</button>
            <button class="active">Log Audit</button>
            <button onclick="location.href='@Url.Action("BookCondition", "Admin")'">Book Condition</button>
            <button onclick="location.href='@Url.Action("UnrestrictRequests", "Admin")'">Unrestrict Requests</button>
        </div>

        <!-- Statistics Section -->
        @if (ViewBag.Statistics != null)
        {
                <div class="statistics-section">
                    <h3>📊 Audit Log Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">@ViewBag.Statistics.TotalLogs</div>
                            <div class="stat-label">Total Logs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@ViewBag.Statistics.TodayLogs</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@ViewBag.Statistics.ThisWeekLogs</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">@ViewBag.Statistics.ThisMonthLogs</div>
                            <div class="stat-label">This Month</div>
                        </div>
                    </div>
                </div>
        }

        <!-- Advanced Filter Section -->
        <div class="filter-section">
            <h3>🔍 Advanced Filters & Search</h3>
            <form id="auditFilterForm">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="searchTerm">Search Term:</label>
                        <input type="text" id="searchTerm" name="searchTerm" placeholder="Search actions, users, or details...">
                    </div>
                    <div class="filter-group">
                        <label for="userRole">User Role:</label>
                        <select id="userRole" name="userRole">
                            <option value="">All Roles</option>
                            <option value="ADMIN">Admin</option>
                            <option value="LIBRARIAN">Librarian</option>
                            <option value="STUDENT">Student</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="actionCategory">Action Category:</label>
                        <select id="actionCategory" name="actionCategory">
                            <option value="">All Categories</option>
                            <option value="BOOK_MANAGEMENT">📚 Book Management</option>
                            <option value="USER_MANAGEMENT">👤 User Management</option>
                            <option value="BORROWING">📖 Borrowing</option>
                            <option value="PENALTY">💰 Penalties</option>
                            <option value="SYSTEM">⚙️ System</option>
                            <option value="SECURITY">🔒 Security</option>
                            <option value="REPORT">📊 Reports</option>
                        </select>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate" name="startDate">
                    </div>
                    <div class="filter-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate" name="endDate">
                    </div>
                    <div class="filter-group">
                        <label for="successFilter">Status:</label>
                        <select id="successFilter" name="successFilter">
                            <option value="">All Status</option>
                            <option value="true">✅ Success Only</option>
                            <option value="false">❌ Failed Only</option>
                        </select>
                    </div>
                </div>

                <div class="filter-buttons">
                    <button type="button" class="btn btn-primary" onclick="applyFilters()">🔍 Apply Filters</button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">🗑️ Clear All</button>
                    <button type="button" class="btn btn-success" onclick="exportLogs()">📥 Export Logs</button>
                </div>
            </form>
        </div>

        <!-- Audit Log History Section -->
        <section class="history-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>AUDIT LOG HISTORY</h3>
                <div style="color: #6c757d; font-size: 14px;">
                    Showing @Model.Count of @ViewBag.TotalCount total entries
                </div>
            </div>

            @if (Model != null && Model.Any())
            {
                @foreach (var log in Model)
                {
                            <div class="log-entry @log.ActionCategory.ToLower().Replace("_", "-")">
                                <div class="log-header">
                                    <div style="display: flex; align-items: center; flex: 1;">
                                        <span class="log-icon">@log.ActionIcon</span>
                                        <span class="log-action">@log.Action</span>
                                    </div>
                                    <span class="log-timestamp">@log.FormattedTimestamp</span>
                                </div>
                                <div class="log-user">
                                    👤 @log.Username [@log.UserRole]
                            @if (!string.IsNullOrEmpty(log.EntityName))
                            {
                                            <span style="color: #6c757d;">→ @log.EntityName</span>
                            }
                                </div>
                                <div class="log-details">
                            @Html.Raw(log.Details.Replace("\n", "<br />"))
                            @if (!log.Success)
                            {
                                            <div style="color: #dc3545; font-weight: 500; margin-top: 5px;">
                                                ❌ Failed: @log.ErrorMessage
                                            </div>
                            }
                            @if (log.DurationMs > 0)
                            {
                                            <div style="color: #6c757d; font-size: 12px; margin-top: 5px;">
                                                ⏱️ Duration: @log.DurationMs ms
                                            </div>
                            }
                                </div>
                            </div>
                }

                    <!-- Pagination -->
                @if (ViewBag.TotalPages > 1)
                {
                            <div class="pagination">
                                <button onclick="changePage(@ViewBag.CurrentPage - 1)" @(ViewBag.HasPrevPage ? "" : "disabled")>
                                    ← Previous
                                </button>

                        @for (int i = Math.Max(1, ViewBag.CurrentPage - 2); i <= Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2); i++)
                        {
                                        <button onclick="changePage(@i)" class="@(i == ViewBag.CurrentPage ? "current-page" : "")">
                                @i
                                        </button>
                        }

                                <button onclick="changePage(@ViewBag.CurrentPage + 1)" @(ViewBag.HasNextPage ? "" : "disabled")>
                                    Next →
                                </button>
                            </div>
                }
            }
            else
            {
                    <div class="no-logs">
                        <div class="no-logs-icon">📋</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">No audit logs found</div>
                        <div style="font-size: 14px;">
                        @if (!string.IsNullOrEmpty(ViewBag.SearchTerm as string))
                        {
                            <text>No logs match your current search criteria. Try adjusting your filters.</text>
                        }
                        else
                        {
                            <text>Audit logs will appear here when users perform actions in the system.</text>
                        }
                        </div>
                    </div>
            }
        </section>
    </main>

    @Html.AntiForgeryToken()

    <script>
        let currentFilters = {};
        let isLoading = false;

        function changePage(page) {
            if (page < 1 || page > @ViewBag.TotalPages) return;

            // Simple page navigation without forms
            const url = new URL(window.location);
            url.searchParams.set('page', page);
            window.location.href = url.toString();
        }

        // Auto-refresh every 30 seconds to show new logs
        setTimeout(function() {
            if (document.visibilityState === 'visible') {
                location.reload();
            }
        }, 30000);

        // Filter Functions
        function applyFilters() {
            if (isLoading) return;

            isLoading = true;
            showLoadingState();

            // Collect filter data
            const filterData = {
                searchTerm: document.getElementById('searchTerm').value.trim(),
                userRole: document.getElementById('userRole').value,
                actionCategory: document.getElementById('actionCategory').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                successFilter: document.getElementById('successFilter').value,
                page: 1,
                pageSize: 50
            };

            // Remove empty values
            Object.keys(filterData).forEach(key => {
                if (filterData[key] === '' || filterData[key] === null) {
                    delete filterData[key];
                }
            });

            currentFilters = filterData;

            // Make AJAX request
            fetch('@Url.Action("LogAuditFilter", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify(filterData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateLogDisplay(data.logs, data.totalCount);
                    updateFilterSummary(data.logs.length, data.totalCount);
                } else {
                    showError('Failed to apply filters. Please try again.');
                }
            })
            .catch(error => {
                console.error('Filter error:', error);
                showError('An error occurred while applying filters.');
            })
            .finally(() => {
                isLoading = false;
                hideLoadingState();
            });
        }

        function clearFilters() {
            document.getElementById('searchTerm').value = '';
            document.getElementById('userRole').value = '';
            document.getElementById('actionCategory').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('successFilter').value = '';

            currentFilters = {};

            // Reload page to show all logs
            window.location.href = '@Url.Action("LogAudit", "Admin")';
        }

        function updateLogDisplay(logs, totalCount) {
            const historySection = document.querySelector('.history-section');
            const logContainer = historySection.querySelector('.log-entries') || historySection;

            if (logs.length === 0) {
                logContainer.innerHTML = `
                    <div class="no-logs">
                        <div class="no-logs-icon">🔍</div>
                        <div style="font-size: 18px; margin-bottom: 10px;">No logs found</div>
                        <div style="font-size: 14px;">No audit logs match your current filter criteria.</div>
                    </div>
                `;
                return;
            }

            let logsHtml = '';
            logs.forEach(log => {
                const successIcon = log.success ? '✅' : '❌';
                const durationText = log.durationMs > 0 ? `<div style="color: #6c757d; font-size: 12px; margin-top: 5px;">⏱️ Duration: ${log.durationMs} ms</div>` : '';
                const errorText = !log.success && log.errorMessage ? `<div style="color: #dc3545; font-weight: 500; margin-top: 5px;">❌ Failed: ${log.errorMessage}</div>` : '';

                logsHtml += `
                    <div class="log-entry ${log.actionCategory ? log.actionCategory.toLowerCase().replace('_', '-') : ''}">
                        <div class="log-header">
                            <div style="display: flex; align-items: center; flex: 1;">
                                <span class="log-icon">${log.actionIcon || '📝'}</span>
                                <span class="log-action">${log.action}</span>
                            </div>
                            <span class="log-timestamp">${log.formattedTimestamp}</span>
                        </div>
                        <div class="log-user">
                            👤 ${log.username} [${log.userRole}] ${log.entityName ? `→ ${log.entityName}` : ''}
                        </div>
                        <div class="log-details">
                            ${successIcon} ${log.details}
                            ${errorText}
                            ${durationText}
                        </div>
                    </div>
                `;
            });

            // Find the container and update it
            const existingLogs = historySection.querySelectorAll('.log-entry');
            existingLogs.forEach(log => log.remove());

            // Insert new logs before pagination
            const pagination = historySection.querySelector('.pagination');
            if (pagination) {
                pagination.insertAdjacentHTML('beforebegin', logsHtml);
            } else {
                historySection.insertAdjacentHTML('beforeend', logsHtml);
            }
        }

        function updateFilterSummary(displayedCount, totalCount) {
            const summaryElement = document.querySelector('.history-section h3').nextElementSibling;
            if (summaryElement) {
                summaryElement.textContent = `Showing ${displayedCount} of ${totalCount} total entries`;
            }
        }

        function showLoadingState() {
            const historySection = document.querySelector('.history-section');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                    <div>Loading audit logs...</div>
                </div>
            `;
            historySection.appendChild(loadingDiv);
        }

        function hideLoadingState() {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showError(message) {
            alert(message); // You can replace this with a better notification system
        }

        function exportLogs() {
            // Create export data
            const exportData = {
                ...currentFilters,
                export: true
            };

            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("LogAuditFilter", "Admin")';

            Object.keys(exportData).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = exportData[key];
                form.appendChild(input);
            });

            // Add CSRF token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                form.appendChild(token.cloneNode());
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        // Set default end date to today
        document.addEventListener('DOMContentLoaded', function() {
            const endDateInput = document.getElementById('endDate');
            if (endDateInput && !endDateInput.value) {
                const today = new Date().toISOString().split('T')[0];
                endDateInput.value = today;
            }
        });

        // Enter key support for search
        document.getElementById('searchTerm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    </script>
</body>
</html>


